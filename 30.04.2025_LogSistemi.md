# MuhasebeStokWebApp Log Sistemi İncelemesi (30.04.2025)

Bu rapor, MuhasebeStokWebApp uygulamasının loglama altyapısını ve kritik işlemlerdeki loglama pratiklerini analiz etmektedir.

## 1. Log Altyapısı

*   **Framework:** Uygulama, loglama altyapısı olarak **Serilog** kullanmaktadır. `Program.cs` dosyasında `builder.Host.UseSerilog()` ile entegrasyon sağlanmıştır. Bu sayede standart `Microsoft.Extensions.Logging.ILogger<T>` arayüzü dependency injection ile kullanılabilmektedir.
*   **Entegrasyon:** `ILogger<T>` arayüzü Controller ve Service sınıflarına constructor injection ile doğru şekilde enjekte edilmektedir.
*   **Log Seviyeleri:**
    *   Varsayılan minimum log seviyesi `Information` olarak ayarlanmıştır (`Program.cs`).
    *   `Microsoft.*` logları için minimum seviye `Warning` olarak override edilmiştir (`Program.cs` ve `appsettings.json`).
    *   Kod içerisinde `LogInformation`, `LogWarning`, `LogError` seviyeleri kullanılmaktadır. `LogCritical` kullanımına rastlanmamıştır, ancak `LogError` ciddi hatalar için kullanılıyor. Seviyelerin kullanımı genel olarak tutarlıdır (Başarı->Information, Hata->Error, Potansiyel Sorun/Bulunamadı->Warning).
*   **Konfigürasyon:** Temel Serilog yapılandırması (minimum seviyeler, sink'ler) merkezi olarak `Program.cs` içinde kod ile yapılmıştır. `appsettings.json` dosyasındaki standart `Logging` bölümü de mevcuttur ancak ana yapılandırma kod tarafındadır.
*   **Log Hedefleri (Sinks):** Loglar hem **Console**'a hem de günlük olarak dönen (`rollingInterval: RollingInterval.Day`) **dosyalara** (`Logs/log-.txt`) yazılmaktadır. Dosya sayısı limiti 31 gün olarak ayarlanmıştır.

## 2. Kritik İşlem Loglamaları

Aşağıdaki kritik işlemlerin loglama durumu incelenmiştir:

*   **Yeni Cari Kaydı Oluşturulması (`CariController.Create` POST):**
    *   **Başarı:** Başarılı kayıt sonrası `LogInformation` **kullanılmıyor**. Kaydın başarıyla tamamlandığına dair bir log eksiktir.
    *   **Hata:** `try-catch` bloğunda hata oluşması durumunda `LogError` ile loglama yapılıyor.
    *   **Uyarı:** Bu işlem özelinde `LogWarning` kullanımı görülmedi.
    *   **Transaction:** Transaction başlatma (`BeginTransactionAsync`), commit (`CommitTransactionAsync`) ve rollback (`RollbackTransactionAsync`) adımları `IUnitOfWork` üzerinden çağrılıyor ancak bu action içinde bu adımlar için **explicit loglama yok**. (Loglama `UnitOfWork` içinde olabilir).
*   **Yeni Fatura Oluşturulması (`FaturaController.Create` POST):**
    *   **Başarı:** İşlem başlangıcı, validasyon sonrası ve başarılı kayıt sonrası (`_faturaService.CreateFatura` çağrısından sonra) `LogInformation` ile loglama yapılıyor. Başarı logu oluşturulan `FaturaID`'yi içeriyor.
    *   **Hata:** `try-catch` bloğunda hata oluşması durumunda `LogError` ile loglama yapılıyor. Form verisi yükleme hatası da ayrıca loglanıyor.
    *   **Uyarı:** Bu işlem özelinde `LogWarning` kullanımı görülmedi.
    *   **Transaction:** Transaction yönetimi `IFaturaService` içine kapsüllenmiş görünüyor. Bu action içinde explicit transaction logları yok.
*   **Fatura Güncellenmesi (`FaturaController.Edit` POST):**
    *   **Başarı:** İşlem başlangıcı, eski stok/FIFO kayıtlarının iptali, yeni stok/FIFO kayıtlarının oluşturulması, cari hareket güncellemesi/oluşturulması gibi **detaylı adımlar** ve işlemin başarıyla tamamlanması `LogInformation` ile loglanıyor. Loglar ilgili ID'leri içeriyor.
    *   **Hata:** Genel hatalar, veritabanı (`DbUpdateException`), eş zamanlılık (`DbUpdateConcurrencyException`), rollback hataları ve FIFO işlem hataları `LogError` ile loglanıyor.
    *   **Uyarı:** Concurrency hatalarında yapılan yeniden denemeler (`retry`) `LogWarning` ile loglanıyor.
    *   **Transaction:** Transaction başlatma (`BeginTransactionAsync`), commit (`CommitAsync`) ve rollback (`RollbackAsync`) adımları kullanılıyor. Başarılı **rollback** için explicit `LogInformation` mevcut. Başlatma ve commit adımları için explicit log yok.
*   **Fatura Silinmesi (`FaturaController.DeleteConfirmed` POST):**
    *   **Başarı:** İşlem başlangıcı ve başarılı silme sonrası (`_faturaService.DeleteFatura` çağrısından sonra) `LogInformation` ile loglama yapılıyor. Log `FaturaID` içeriyor.
    *   **Hata:** `try-catch` bloğunda hata oluşması durumunda `LogError` ile loglama yapılıyor.
    *   **Uyarı:** Silinecek fatura servis tarafından bulunamazsa (`_faturaService.DeleteFatura` false dönerse) `LogWarning` ile loglama yapılıyor.
    *   **Transaction:** Transaction yönetimi `IFaturaService` içine kapsüllenmiş görünüyor. Bu action içinde explicit transaction logları yok.
*   **FIFO İşlemleri (`StokFifoService`):**
    *   **Başarı:** `StokGirisiYap`, `StokCikisiYap`, `FifoKayitlariniIptalEt` gibi ana metotların başlangıcı, adımları (para birimi dönüşümü, kayıt bulma, kayıt kullanma vb.) ve başarılı tamamlanması **çok detaylı** bir şekilde `LogInformation` ile loglanıyor. İlgili ID'ler, miktarlar, maliyetler loglarda mevcut.
    *   **Hata:** Genel hatalar, yetersiz stok (`StokYetersizException`), para birimi dönüşüm hataları, concurrency hataları `LogError` ile loglanıyor.
    *   **Uyarı:** Para birimi dönüşümünde fallback kullanılması, concurrency hatalarında yeniden denemeler, kritik olmayan hatalar (örn: `StokCikisDetay` iptal hatası) `LogWarning` ile loglanıyor.
    *   **Transaction:** Servis kendi içinde transaction yönetimi yapıyor ve başlatma, commit, rollback adımları için **explicit loglama** mevcut (`LogInformation` ve `LogWarning`).
*   **Stok Hareketi Ekleme/Silme:**
    *   Loglama genellikle işlemin yapıldığı context'e (örn: Fatura, İrsaliye) bağlı.
    *   `FaturaController.Edit` içinde yeni stok hareketi oluşturma ve eskiyi silindi olarak işaretleme `LogInformation` ile loglanıyor.
    *   Silme işlemi genellikle ilgili servis (örn: `FaturaService`) içinde yapılıyor ve loglama orada olmalı.
*   **Cari Hareket Oluşturma/Güncelleme:**
    *   Loglama **tutarsız**.
    *   `CariController.Create` ve `Edit` içinde hareket oluşturma için özel log yok.
    *   `CariController.HareketEkle` başarı logu için `ILogService` kullanıyor, hata için `_logger.LogError`.
    *   `CariController.CariHareketSil` başarı logu **eksik**, hata için `_logger.LogError` kullanıyor.
    *   `FaturaController.Edit` içinde ilgili cari hareketin oluşturulması/güncellenmesi adımları `LogInformation` ile loglanıyor.

## 3. Log Mesajlarının İçerik Kalitesi

*   **Bağlam (Context):** Log mesajları genellikle işlemi ve ilgili varlıkları (FaturaID, UrunID, StokFifoID, Miktar, Maliyet vb.) içeriyor. Özellikle `StokFifoService` ve `FaturaController.Edit` logları bağlam açısından zengindir. `CariController` logları daha az detaylıdır.
*   **Kullanıcı Bilgisi (UserID/UserName):** Log mesajlarında işlemi yapan kullanıcıya ait `UserID` veya `UserName` bilgisi **genellikle eksik**. Kullanıcı ID'si bazen alınıp entity'lere kaydedilse veya servislere parametre olarak geçilse de, log mesajlarına doğrudan eklenmiyor. Bu, hangi kullanıcının hangi işlemi yaptığını takip etmeyi zorlaştırabilir.
*   **Takip ID'leri (RequestId/TraceId):** Serilog yapılandırmasında `Enrich.FromLogContext()` kullanılıyor. Bu, ASP.NET Core'un otomatik olarak ürettiği `RequestId` ve `TraceId` gibi bilgilerin loglara eklenmesini sağlayabilir (eğer middleware doğru yapılandırılmışsa, ki genellikle varsayılan olarak böyledir). Ancak logların gerçek çıktısı görülmeden kesin olarak teyit edilemez.

## 4. Loglama Performansı ve Sorunlar

*   **Gereksiz/Aşırı Detaylı Loglar:** `StokFifoService` ve `FaturaController.Edit` içindeki `LogInformation` seviyesindeki loglar oldukça detaylıdır. Bu, geliştirme ve hata ayıklama sırasında faydalı olsa da, varsayılan `Information` seviyesi ile production ortamında çalıştırıldığında log dosyalarının hızla büyümesine ve potansiyel performans etkisine neden olabilir. Bazı adımların log seviyesi `Debug` olarak değiştirilebilir veya production ortamında minimum log seviyesi `Warning`'e yükseltilebilir.
*   **Performans Etkisi:** Mevcut `Information` seviyesi ve detaylı loglama ile yüksek trafikli işlemlerde (özellikle FIFO işlemleri) disk I/O nedeniyle performans etkisi olabilir. Log seviyelerinin ortama göre ayarlanması önemlidir.
*   **İlkel Log Yöntemleri:** `search_files` aracı ile `AdminCreator.cs`, `MenuController.cs` ve `Services/ParaBirimiModulu/ParaBirimiService.cs` dosyalarında `Console.WriteLine` kullanıldığı tespit edildi. Bu kullanımlar standart `ILogger` ile değiştirilmelidir.

## Genel Özet ve İyileştirme Önerileri

*   **Altyapı:** Serilog tabanlı sağlam bir loglama altyapısı kurulmuş. `ILogger` kullanımı yaygın.
*   **Tutarlılık:** Loglama seviyeleri genel olarak tutarlı kullanılsa da, Cari Hareket işlemleri gibi bazı alanlarda loglama eksik veya farklı mekanizmalar (`ILogService`) kullanılıyor. Tüm loglamaların standart `ILogger` üzerinden yapılması önerilir.
*   **Eksik Loglar:**
    *   `CariController.Create` başarı logu eksik.
    *   `CariController.CariHareketSil` başarı logu eksik.
    *   Bazı `CariHareket` oluşturma adımları için özel loglar eksik.
*   **İçerik:**
    *   **Kullanıcı Bilgisi:** Log mesajlarına işlemi yapan `UserID` veya `UserName` eklenmelidir. Bu, denetim ve takip için kritiktir. Serilog enricher'ları (örneğin HttpContext'ten kullanıcı bilgisi ekleyen) kullanılabilir.
    *   **Transaction ID:** Mümkünse, veritabanı transaction ID'lerinin loglanması, özellikle karmaşık işlemlerde hata ayıklamayı kolaylaştırabilir.
*   **Performans:**
    *   Production ortamı için minimum log seviyesinin `Warning` olarak ayarlanması değerlendirilmelidir.
    *   `StokFifoService` gibi çok detaylı loglama yapan servislerdeki bazı `Information` logları `Debug` seviyesine çekilebilir.
*   **Kod Kalitesi:** Tespit edilen `Console.WriteLine` kullanımları kaldırılmalı ve yerine `ILogger` kullanılmalıdır.
*   **`ILogService`:** `CariController` içinde kullanılan özel `ILogService`'in amacı ve `ILogger` ile ilişkisi gözden geçirilmelidir. Mümkünse tek bir standart loglama mekanizması (`ILogger`) tercih edilmelidir.

Genel olarak loglama altyapısı iyi durumda ancak belirtilen eksikliklerin giderilmesi, içerik kalitesinin artırılması (özellikle kullanıcı bilgisi) ve performans optimizasyonları ile daha etkin hale getirilebilir.
