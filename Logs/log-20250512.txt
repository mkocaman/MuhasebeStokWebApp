2025-05-12 00:02:21.204 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 00:02:22.312 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 00:02:22.447 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 00:02:22.450 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 00:02:22.567 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 00:02:40.916 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 00:02:40.975 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-001
2025-05-12 00:02:41.012 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-001
2025-05-12 00:02:41.101 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 00:02:41.145 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 00:02:41.253 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 00:02:41.310 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 00:02:41.417 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 00:02:41.419 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 00:02:41.488 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 00:03:20.979 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 00:03:22.061 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 00:03:22.214 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 00:03:22.217 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 00:03:22.336 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 00:08:46.686 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 00:08:47.922 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 00:08:48.065 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 00:08:48.067 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 00:08:48.202 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 00:09:08.593 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 00:09:08.655 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-001
2025-05-12 00:09:08.690 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-001
2025-05-12 00:09:08.779 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 00:09:08.822 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 00:09:08.930 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 00:09:08.986 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 00:09:09.099 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 00:09:09.101 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 00:09:09.173 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 00:09:12.012 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 00:09:12.041 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-001
2025-05-12 00:09:12.077 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-001
2025-05-12 00:09:12.107 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 00:09:12.135 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 00:09:12.167 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 00:09:12.196 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 00:09:12.284 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 00:09:12.285 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 00:09:12.316 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 00:12:39.508 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 00:12:40.651 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 00:12:40.784 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 00:12:40.787 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 00:12:40.908 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 00:13:11.626 +03:00 [INF] Giriş denemesi: admin
2025-05-12 00:13:11.934 +03:00 [INF] Admin kullanıcısı başarıyla giriş yaptı: admin
2025-05-12 00:13:11.935 +03:00 [INF] Admin session oluşturuldu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 00:13:11.935 +03:00 [INF] Yönlendirme adresi: /Fatura
2025-05-12 00:13:11.936 +03:00 [INF] Admin kullanıcısı /Fatura adresine yönlendiriliyor
2025-05-12 00:15:04.075 +03:00 [INF] Dashboard sayfası yükleniyor...
2025-05-12 00:15:04.079 +03:00 [INF] Dashboard verileri yükleniyor...
2025-05-12 00:15:04.412 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: USD -> TRY, Değer: 33.33
2025-05-12 00:15:04.649 +03:00 [INF] Kur değeri hesaplandı: USD -> UZS, Değer: 12899.450300
2025-05-12 00:15:05.513 +03:00 [INF] Kur değeri önbellekten alındı: USD -> TRY, Değer: 33.33
2025-05-12 00:15:05.514 +03:00 [INF] Kur değeri önbellekten alındı: USD -> UZS, Değer: 12899.450300
2025-05-12 00:15:06.338 +03:00 [INF] Kur değeri önbellekten alındı: USD -> TRY, Değer: 33.33
2025-05-12 00:15:06.342 +03:00 [INF] Kur değeri önbellekten alındı: USD -> UZS, Değer: 12899.450300
2025-05-12 00:15:06.343 +03:00 [INF] Dashboard sayfası başarıyla yüklendi.
2025-05-12 00:15:07.808 +03:00 [INF] Aktif session bulundu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 00:15:07.810 +03:00 [INF] Admin kullanıcısı tespit edildi
2025-05-12 00:15:07.811 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 00:15:08.090 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: TRY -> USD, Değer: 0.03
2025-05-12 00:15:08.259 +03:00 [INF] Kur değeri hesaplandı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 00:17:40.919 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 00:17:40.954 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 00:22:28.163 +03:00 [INF] Aktif session bulundu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 00:22:28.164 +03:00 [INF] Admin kullanıcısı tespit edildi
2025-05-12 00:22:28.165 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 00:22:28.300 +03:00 [INF] Kur değeri önbellekten alındı: TRY -> USD, Değer: 0.03
2025-05-12 00:22:28.301 +03:00 [INF] Kur değeri önbellekten alındı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 00:22:40.958 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 00:22:40.987 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 00:27:40.995 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 00:27:41.027 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:08:25.540 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 12:08:26.831 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 12:08:26.988 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 12:08:26.991 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:08:27.114 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:08:31.022 +03:00 [INF] Giriş denemesi: admin
2025-05-12 12:08:31.339 +03:00 [INF] Admin kullanıcısı başarıyla giriş yaptı: admin
2025-05-12 12:08:31.339 +03:00 [INF] Admin session oluşturuldu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 12:08:31.340 +03:00 [INF] Yönlendirme adresi: /
2025-05-12 12:08:31.341 +03:00 [INF] Admin kullanıcısı / adresine yönlendiriliyor
2025-05-12 12:08:31.613 +03:00 [INF] Aktif session bulundu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 12:08:31.616 +03:00 [INF] Admin kullanıcısı tespit edildi
2025-05-12 12:08:31.616 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 12:08:32.136 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: TRY -> USD, Değer: 0.03
2025-05-12 12:08:32.362 +03:00 [INF] Kur değeri hesaplandı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 12:08:48.882 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 12:08:48.934 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 12:08:48.965 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 12:08:49.010 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 12:08:49.051 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 12:08:49.112 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 12:08:49.163 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 12:08:49.274 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 12:08:49.276 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 12:08:49.322 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 12:13:33.295 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 12:13:34.544 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 12:13:34.692 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 12:13:34.695 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:13:34.828 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:13:45.309 +03:00 [WRN] Session bulunamadı, kullanıcı giriş yapmamış olabilir
2025-05-12 12:13:45.311 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 12:13:45.783 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: TRY -> USD, Değer: 0.03
2025-05-12 12:13:46.034 +03:00 [INF] Kur değeri hesaplandı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 12:13:54.480 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 12:13:54.537 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 12:13:54.569 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 12:13:54.614 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 12:13:54.657 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 12:13:54.721 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 12:13:54.772 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 12:13:54.887 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 12:13:54.889 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 12:13:54.936 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 12:18:34.844 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:18:34.884 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:23:34.896 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:23:35.031 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:25:43.367 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 12:25:44.483 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 12:25:44.624 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 12:25:44.626 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:25:44.744 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:25:45.318 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 12:25:45.383 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 12:25:45.413 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 12:25:45.558 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 12:25:45.597 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 12:25:45.700 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 12:25:45.752 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 12:25:45.858 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 12:25:45.860 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 12:25:45.930 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 12:26:47.583 +03:00 [WRN] Session bulunamadı, kullanıcı giriş yapmamış olabilir
2025-05-12 12:26:47.585 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 12:26:47.889 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: TRY -> USD, Değer: 0.03
2025-05-12 12:26:48.111 +03:00 [INF] Kur değeri hesaplandı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 12:26:48.595 +03:00 [WRN] Session bulunamadı, kullanıcı giriş yapmamış olabilir
2025-05-12 12:26:48.596 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 12:26:48.733 +03:00 [INF] Kur değeri önbellekten alındı: TRY -> USD, Değer: 0.03
2025-05-12 12:26:48.734 +03:00 [INF] Kur değeri önbellekten alındı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 12:26:54.519 +03:00 [INF] Dashboard sayfası yükleniyor...
2025-05-12 12:26:54.522 +03:00 [INF] Dashboard verileri yükleniyor...
2025-05-12 12:26:54.823 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: USD -> TRY, Değer: 33.33
2025-05-12 12:26:54.963 +03:00 [INF] Kur değeri hesaplandı: USD -> UZS, Değer: 12899.450300
2025-05-12 12:26:55.806 +03:00 [INF] Kur değeri önbellekten alındı: USD -> TRY, Değer: 33.33
2025-05-12 12:26:55.807 +03:00 [INF] Kur değeri önbellekten alındı: USD -> UZS, Değer: 12899.450300
2025-05-12 12:26:56.602 +03:00 [INF] Kur değeri önbellekten alındı: USD -> TRY, Değer: 33.33
2025-05-12 12:26:56.603 +03:00 [INF] Kur değeri önbellekten alındı: USD -> UZS, Değer: 12899.450300
2025-05-12 12:26:56.604 +03:00 [INF] Dashboard sayfası başarıyla yüklendi.
2025-05-12 12:30:44.751 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:30:44.784 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:35:44.799 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:35:44.948 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:40:44.949 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:40:44.983 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:41:24.601 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 12:41:26.541 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 12:41:26.681 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 12:41:26.683 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:41:26.795 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:41:55.659 +03:00 [INF] Giriş denemesi: admin
2025-05-12 12:41:55.913 +03:00 [INF] Admin kullanıcısı başarıyla giriş yaptı: admin
2025-05-12 12:41:55.913 +03:00 [INF] Admin session oluşturuldu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 12:41:55.914 +03:00 [INF] Yönlendirme adresi: /SistemAyar
2025-05-12 12:41:55.915 +03:00 [INF] Admin kullanıcısı /SistemAyar adresine yönlendiriliyor
2025-05-12 12:44:06.311 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 12:44:07.565 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 12:44:07.705 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 12:44:07.708 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:44:07.874 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:48:57.082 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 12:48:58.170 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 12:48:58.306 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 12:48:58.309 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:48:58.454 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 12:49:09.327 +03:00 [WRN] Session bulunamadı, kullanıcı giriş yapmamış olabilir
2025-05-12 12:49:09.330 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 12:49:09.775 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: TRY -> USD, Değer: 0.03
2025-05-12 12:49:09.992 +03:00 [INF] Kur değeri hesaplandı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 12:54:03.208 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 12:54:04.405 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 12:54:04.524 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 12:54:04.527 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 12:54:04.656 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:02:20.329 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 13:02:21.508 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 13:02:21.657 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 13:02:21.660 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:02:21.804 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:07:21.810 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:07:21.843 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:12:21.851 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:12:22.002 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:17:22.013 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:17:22.044 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:18:50.344 +03:00 [INF] Giriş denemesi: admin
2025-05-12 13:18:50.595 +03:00 [INF] Admin kullanıcısı başarıyla giriş yaptı: admin
2025-05-12 13:18:50.596 +03:00 [INF] Admin session oluşturuldu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 13:18:50.596 +03:00 [INF] Yönlendirme adresi: /Irsaliye/Edit/46bb8e25-7433-4c72-8400-4904a4a147f3
2025-05-12 13:18:50.597 +03:00 [INF] Admin kullanıcısı /Irsaliye/Edit/46bb8e25-7433-4c72-8400-4904a4a147f3 adresine yönlendiriliyor
2025-05-12 13:22:22.054 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:22:22.092 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:23:36.067 +03:00 [INF] Aktif session bulundu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 13:23:36.070 +03:00 [INF] Admin kullanıcısı tespit edildi
2025-05-12 13:23:36.070 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 13:23:36.354 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: TRY -> USD, Değer: 0.03
2025-05-12 13:23:36.549 +03:00 [INF] Kur değeri hesaplandı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 13:23:44.332 +03:00 [INF] Dashboard sayfası yükleniyor...
2025-05-12 13:23:44.334 +03:00 [INF] Dashboard verileri yükleniyor...
2025-05-12 13:23:44.633 +03:00 [INF] TRY dönüşümü için kur değeri hesaplandı: USD -> TRY, Değer: 33.33
2025-05-12 13:23:44.778 +03:00 [INF] Kur değeri hesaplandı: USD -> UZS, Değer: 12899.450300
2025-05-12 13:23:45.608 +03:00 [INF] Kur değeri önbellekten alındı: USD -> TRY, Değer: 33.33
2025-05-12 13:23:45.609 +03:00 [INF] Kur değeri önbellekten alındı: USD -> UZS, Değer: 12899.450300
2025-05-12 13:23:46.388 +03:00 [INF] Kur değeri önbellekten alındı: USD -> TRY, Değer: 33.33
2025-05-12 13:23:46.390 +03:00 [INF] Kur değeri önbellekten alındı: USD -> UZS, Değer: 12899.450300
2025-05-12 13:23:46.391 +03:00 [INF] Dashboard sayfası başarıyla yüklendi.
2025-05-12 13:23:57.870 +03:00 [INF] Aktif session bulundu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 13:23:57.871 +03:00 [INF] Admin kullanıcısı tespit edildi
2025-05-12 13:23:57.871 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 13:23:58.015 +03:00 [INF] Kur değeri önbellekten alındı: TRY -> USD, Değer: 0.03
2025-05-12 13:23:58.016 +03:00 [INF] Kur değeri önbellekten alındı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 13:23:59.772 +03:00 [INF] Aktif session bulundu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 13:23:59.773 +03:00 [INF] Admin kullanıcısı tespit edildi
2025-05-12 13:23:59.774 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 13:23:59.917 +03:00 [INF] Kur değeri önbellekten alındı: TRY -> USD, Değer: 0.03
2025-05-12 13:23:59.918 +03:00 [INF] Kur değeri önbellekten alındı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 13:24:00.251 +03:00 [INF] Aktif session bulundu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 13:24:00.251 +03:00 [INF] Admin kullanıcısı tespit edildi
2025-05-12 13:24:00.252 +03:00 [INF] Kimlik doğrulanmış kullanıcı: admin
2025-05-12 13:24:00.391 +03:00 [INF] Kur değeri önbellekten alındı: TRY -> USD, Değer: 0.03
2025-05-12 13:24:00.392 +03:00 [INF] Kur değeri önbellekten alındı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 13:24:02.664 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 13:27:22.094 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:27:22.122 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:32:22.128 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:32:22.156 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:35:10.268 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 13:35:10.314 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 13:35:10.339 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 13:35:10.380 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 13:35:10.418 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 13:35:10.445 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 13:35:10.493 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 13:35:10.578 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 13:35:10.579 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 13:35:10.612 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 13:37:22.162 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:37:22.194 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:40:38.560 +03:00 [INF] İrsaliye oluşturma sayfası yükleniyor
2025-05-12 13:40:39.316 +03:00 [INF] Yeni irsaliye numarası oluşturuldu: IRS-250512-0003
2025-05-12 13:42:22.201 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:42:22.227 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:45:51.719 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 13:45:52.871 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 13:45:53.016 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 13:45:53.019 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:45:53.141 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:49:57.939 +03:00 [INF] Giriş denemesi: admin
2025-05-12 13:49:58.227 +03:00 [INF] Admin kullanıcısı başarıyla giriş yaptı: admin
2025-05-12 13:49:58.228 +03:00 [INF] Admin session oluşturuldu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 13:49:58.229 +03:00 [INF] Yönlendirme adresi: /ParaBirimi/Index
2025-05-12 13:49:58.230 +03:00 [INF] Admin kullanıcısı /ParaBirimi/Index adresine yönlendiriliyor
2025-05-12 13:50:53.153 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:50:53.188 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 13:55:53.200 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 13:55:53.234 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:00:15.361 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 14:00:16.516 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 14:00:16.652 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 14:00:16.655 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:00:16.827 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:09:31.543 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 14:09:32.822 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 14:09:32.985 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 14:09:32.988 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:09:33.494 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:12:51.873 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 14:12:52.971 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 14:12:53.105 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 14:12:53.108 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:12:53.236 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:15:34.262 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 14:15:44.986 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 14:15:45.145 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 14:15:45.147 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:15:45.744 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:20:45.745 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:20:45.776 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:41:03.862 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 14:41:05.053 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 14:41:05.220 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 14:41:05.223 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:41:05.366 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:41:50.382 +03:00 [INF] Giriş denemesi: admin
2025-05-12 14:41:50.696 +03:00 [INF] Admin kullanıcısı başarıyla giriş yaptı: admin
2025-05-12 14:41:50.696 +03:00 [INF] Admin session oluşturuldu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 14:41:50.697 +03:00 [INF] Yönlendirme adresi: /Fatura/Edit/18b6763e-1a94-401b-ba81-b265b66ac2ae
2025-05-12 14:41:50.698 +03:00 [INF] Admin kullanıcısı /Fatura/Edit/18b6763e-1a94-401b-ba81-b265b66ac2ae adresine yönlendiriliyor
2025-05-12 14:42:01.098 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:01.300 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:42:01.302 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 18b6763e-1a94-401b-ba81-b265b66ac2ae
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:42:01.334 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:01.338 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=18b6763e-1a94-401b-ba81-b265b66ac2ae, ReferansTuru=Fatura
2025-05-12 14:42:01.339 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=18b6763e-1a94-401b-ba81-b265b66ac2ae
2025-05-12 14:42:01.410 +03:00 [INF] FIFO kayıtları iptal ediliyor. Toplam 1 kayıt bulundu.
2025-05-12 14:42:01.667 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:01.794 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:01.880 +03:00 [INF] Cari hareket silindi. CariHareketID: "1a21815b-351a-4c84-aba1-39b7d5c633e4"
2025-05-12 14:42:01.920 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:01.934 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:42:01.939 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 100
2025-05-12 14:42:01.944 +03:00 [INF] StokGirisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 100
2025-05-12 14:42:02.160 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:42:02.172 +03:00 [ERR] Stok girişi sırasında hata oluştu: UrunID=2216d3ad-9370-49a9-847e-c374b130978d, Miktar=100, BirimFiyat=15.00
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
2025-05-12 14:42:02.180 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae", Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
2025-05-12 14:42:02.218 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:02.220 +03:00 [ERR] Fatura güncelleme hatası
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:42:09.345 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:09.432 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:42:09.433 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 18b6763e-1a94-401b-ba81-b265b66ac2ae
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:42:09.437 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:09.437 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=18b6763e-1a94-401b-ba81-b265b66ac2ae, ReferansTuru=Fatura
2025-05-12 14:42:09.438 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=18b6763e-1a94-401b-ba81-b265b66ac2ae
2025-05-12 14:42:09.470 +03:00 [INF] FIFO kayıtları iptal ediliyor. Toplam 1 kayıt bulundu.
2025-05-12 14:42:09.551 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:09.581 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:09.610 +03:00 [INF] Cari hareket silindi. CariHareketID: "1a21815b-351a-4c84-aba1-39b7d5c633e4"
2025-05-12 14:42:09.638 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:09.640 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:42:09.641 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 100
2025-05-12 14:42:09.642 +03:00 [INF] StokGirisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 100
2025-05-12 14:42:09.770 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:42:09.781 +03:00 [ERR] Stok girişi sırasında hata oluştu: UrunID=2216d3ad-9370-49a9-847e-c374b130978d, Miktar=100, BirimFiyat=15.00
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
2025-05-12 14:42:09.789 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae", Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
2025-05-12 14:42:09.822 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "18b6763e-1a94-401b-ba81-b265b66ac2ae"
2025-05-12 14:42:09.824 +03:00 [ERR] Fatura güncelleme hatası
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:43:05.640 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:05.720 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:43:05.721 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: e07c4b39-39ea-4a69-897f-4f96da99c103
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:43:05.724 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:05.725 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=e07c4b39-39ea-4a69-897f-4f96da99c103, ReferansTuru=Fatura
2025-05-12 14:43:05.725 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=e07c4b39-39ea-4a69-897f-4f96da99c103
2025-05-12 14:43:05.753 +03:00 [INF] FIFO kayıtları iptal ediliyor. Toplam 1 kayıt bulundu.
2025-05-12 14:43:05.840 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:05.867 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:05.894 +03:00 [INF] Cari hareket silindi. CariHareketID: "efc2ce1c-6dd2-4fbf-9b0c-11a040eef1e4"
2025-05-12 14:43:05.921 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:05.923 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:43:05.924 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 10
2025-05-12 14:43:05.925 +03:00 [INF] StokGirisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 10
2025-05-12 14:43:06.039 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:43:06.049 +03:00 [ERR] Stok girişi sırasında hata oluştu: UrunID=2216d3ad-9370-49a9-847e-c374b130978d, Miktar=10, BirimFiyat=40.00
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
2025-05-12 14:43:06.058 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103", Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
2025-05-12 14:43:06.092 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:06.093 +03:00 [ERR] Fatura güncelleme hatası
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:43:14.593 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:14.676 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:43:14.677 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: e07c4b39-39ea-4a69-897f-4f96da99c103
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:43:14.681 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:14.681 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=e07c4b39-39ea-4a69-897f-4f96da99c103, ReferansTuru=Fatura
2025-05-12 14:43:14.682 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=e07c4b39-39ea-4a69-897f-4f96da99c103
2025-05-12 14:43:14.707 +03:00 [INF] FIFO kayıtları iptal ediliyor. Toplam 1 kayıt bulundu.
2025-05-12 14:43:14.784 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:14.818 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:14.844 +03:00 [INF] Cari hareket silindi. CariHareketID: "efc2ce1c-6dd2-4fbf-9b0c-11a040eef1e4"
2025-05-12 14:43:14.872 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:14.873 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:43:14.874 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 10.00
2025-05-12 14:43:14.875 +03:00 [INF] StokGirisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 10.00
2025-05-12 14:43:14.979 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:43:14.990 +03:00 [ERR] Stok girişi sırasında hata oluştu: UrunID=2216d3ad-9370-49a9-847e-c374b130978d, Miktar=10.00, BirimFiyat=40.00
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
2025-05-12 14:43:15.000 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103", Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
2025-05-12 14:43:15.036 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:15.037 +03:00 [ERR] Fatura güncelleme hatası
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:43:19.866 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:19.943 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:43:19.944 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: e07c4b39-39ea-4a69-897f-4f96da99c103
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:43:19.948 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:19.949 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=e07c4b39-39ea-4a69-897f-4f96da99c103, ReferansTuru=Fatura
2025-05-12 14:43:19.950 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=e07c4b39-39ea-4a69-897f-4f96da99c103
2025-05-12 14:43:19.975 +03:00 [INF] FIFO kayıtları iptal ediliyor. Toplam 1 kayıt bulundu.
2025-05-12 14:43:20.055 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:20.080 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:20.108 +03:00 [INF] Cari hareket silindi. CariHareketID: "efc2ce1c-6dd2-4fbf-9b0c-11a040eef1e4"
2025-05-12 14:43:20.135 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:20.136 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:43:20.137 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 10.00
2025-05-12 14:43:20.138 +03:00 [INF] StokGirisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 10.00
2025-05-12 14:43:20.242 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:43:20.252 +03:00 [ERR] Stok girişi sırasında hata oluştu: UrunID=2216d3ad-9370-49a9-847e-c374b130978d, Miktar=10.00, BirimFiyat=40.00
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
2025-05-12 14:43:20.259 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103", Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
2025-05-12 14:43:20.290 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "e07c4b39-39ea-4a69-897f-4f96da99c103"
2025-05-12 14:43:20.292 +03:00 [ERR] Fatura güncelleme hatası
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 218
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 240
   at MuhasebeStokWebApp.Services.StokFifoService.StokGirisiYap(Guid urunID, Decimal miktar, Decimal birimFiyat, String birim, String referansNo, String referansTuru, Nullable`1 referansID, String aciklama, String paraBirimi, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 249
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 493
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:44:00.226 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:44:00.328 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:44:00.328 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:44:00.331 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:44:00.332 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:44:00.332 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
2025-05-12 14:44:00.360 +03:00 [WRN] İptal edilecek FIFO kaydı bulunamadı: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:44:00.360 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:44:00.389 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:44:00.422 +03:00 [INF] Cari hareket silindi. CariHareketID: "2cb7fe3e-7c75-49dc-9192-29975c14a863"
2025-05-12 14:44:00.451 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:44:00.452 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:44:00.453 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 14.00
2025-05-12 14:44:00.461 +03:00 [INF] StokCikisiYap başladı: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.00, Hareket Tipi Cikis
2025-05-12 14:44:00.462 +03:00 [INF] StokCikisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.00
2025-05-12 14:44:00.604 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:44:00.614 +03:00 [ERR] FIFO işlemi sırasında beklenmeyen hata: StokFifoID: 85259f4b-9668-46b6-8e2e-41955eeaaa19, Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
2025-05-12 14:44:00.621 +03:00 [ERR] Stok çıkışı sırasında hata oluştu: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.00
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
2025-05-12 14:44:00.629 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47", Hata: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
2025-05-12 14:44:00.663 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:44:00.663 +03:00 [ERR] Fatura güncelleme hatası
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:46:05.368 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:46:05.398 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:48:41.977 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:42.062 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:48:42.063 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:48:42.066 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:42.067 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:42.068 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
2025-05-12 14:48:42.094 +03:00 [WRN] İptal edilecek FIFO kaydı bulunamadı: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:42.094 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:42.121 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:42.148 +03:00 [INF] Cari hareket silindi. CariHareketID: "2cb7fe3e-7c75-49dc-9192-29975c14a863"
2025-05-12 14:48:42.175 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:42.176 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:48:42.177 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 15
2025-05-12 14:48:42.179 +03:00 [INF] StokCikisiYap başladı: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15, Hareket Tipi Cikis
2025-05-12 14:48:42.180 +03:00 [INF] StokCikisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15
2025-05-12 14:48:42.295 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:48:42.306 +03:00 [ERR] FIFO işlemi sırasında beklenmeyen hata: StokFifoID: 85259f4b-9668-46b6-8e2e-41955eeaaa19, Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
2025-05-12 14:48:42.318 +03:00 [ERR] Stok çıkışı sırasında hata oluştu: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
2025-05-12 14:48:42.328 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47", Hata: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
2025-05-12 14:48:42.366 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:42.367 +03:00 [ERR] Fatura güncelleme hatası
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:48:51.110 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:51.190 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:48:51.191 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:48:51.194 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:51.194 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:51.195 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
2025-05-12 14:48:51.220 +03:00 [WRN] İptal edilecek FIFO kaydı bulunamadı: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:51.221 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:51.249 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:51.276 +03:00 [INF] Cari hareket silindi. CariHareketID: "2cb7fe3e-7c75-49dc-9192-29975c14a863"
2025-05-12 14:48:51.304 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:51.305 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:48:51.306 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 14.99
2025-05-12 14:48:51.307 +03:00 [INF] StokCikisiYap başladı: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.99, Hareket Tipi Cikis
2025-05-12 14:48:51.308 +03:00 [INF] StokCikisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.99
2025-05-12 14:48:51.416 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:48:51.428 +03:00 [ERR] FIFO işlemi sırasında beklenmeyen hata: StokFifoID: 85259f4b-9668-46b6-8e2e-41955eeaaa19, Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
2025-05-12 14:48:51.439 +03:00 [ERR] Stok çıkışı sırasında hata oluştu: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.99
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
2025-05-12 14:48:51.448 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47", Hata: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
2025-05-12 14:48:51.484 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:51.485 +03:00 [ERR] Fatura güncelleme hatası
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:48:55.067 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:55.162 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:48:55.163 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:48:55.167 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:55.168 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:55.168 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
2025-05-12 14:48:55.196 +03:00 [WRN] İptal edilecek FIFO kaydı bulunamadı: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:55.197 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:55.238 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:55.264 +03:00 [INF] Cari hareket silindi. CariHareketID: "2cb7fe3e-7c75-49dc-9192-29975c14a863"
2025-05-12 14:48:55.290 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:55.292 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:48:55.293 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 14.99
2025-05-12 14:48:55.294 +03:00 [INF] StokCikisiYap başladı: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.99, Hareket Tipi Cikis
2025-05-12 14:48:55.295 +03:00 [INF] StokCikisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.99
2025-05-12 14:48:55.399 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:48:55.413 +03:00 [ERR] FIFO işlemi sırasında beklenmeyen hata: StokFifoID: 85259f4b-9668-46b6-8e2e-41955eeaaa19, Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
2025-05-12 14:48:55.422 +03:00 [ERR] Stok çıkışı sırasında hata oluştu: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 14.99
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
2025-05-12 14:48:55.431 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47", Hata: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
2025-05-12 14:48:55.468 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:55.469 +03:00 [ERR] Fatura güncelleme hatası
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:48:58.089 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:58.174 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 14:48:58.175 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 14:48:58.178 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:58.179 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:58.179 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
2025-05-12 14:48:58.205 +03:00 [WRN] İptal edilecek FIFO kaydı bulunamadı: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 14:48:58.205 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:58.231 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:58.258 +03:00 [INF] Cari hareket silindi. CariHareketID: "2cb7fe3e-7c75-49dc-9192-29975c14a863"
2025-05-12 14:48:58.284 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:58.286 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 14:48:58.287 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 15
2025-05-12 14:48:58.288 +03:00 [INF] StokCikisiYap başladı: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15, Hareket Tipi Cikis
2025-05-12 14:48:58.288 +03:00 [INF] StokCikisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15
2025-05-12 14:48:58.396 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 14:48:58.410 +03:00 [ERR] FIFO işlemi sırasında beklenmeyen hata: StokFifoID: 85259f4b-9668-46b6-8e2e-41955eeaaa19, Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
2025-05-12 14:48:58.419 +03:00 [ERR] Stok çıkışı sırasında hata oluştu: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
2025-05-12 14:48:58.438 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47", Hata: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
2025-05-12 14:48:58.533 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 14:48:58.534 +03:00 [ERR] Fatura güncelleme hatası
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:aa8b877b-ab2d-4a4e-98bc-e005c300ef5c
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 14:51:05.412 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:51:05.446 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 14:56:05.447 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 14:56:05.474 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:01:05.478 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:01:05.650 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:06:05.662 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:06:05.697 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:11:05.707 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:11:05.742 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:13:43.311 +03:00 [INF] Fatura ve ilişkili kayıtlar güncelleniyor. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 15:13:43.399 +03:00 [INF] UpdateAsync işlemi başlatılıyor
2025-05-12 15:13:43.400 +03:00 [ERR] FaturaTransactionService.UpdateAsync Parametreler: 1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
System.InvalidOperationException: The connection is already in a transaction and cannot participate in another transaction.
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.EnsureNoTransactions()
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(IsolationLevel isolationLevel, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalConnection.BeginTransactionAsync(CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Data.Repositories.UnitOfWork.BeginTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Data\Repositories\UnitOfWork.cs:line 106
   at MuhasebeStokWebApp.Services.FaturaTransactionService.EnsureTransactionAsync() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 37
   at MuhasebeStokWebApp.Services.FaturaTransactionService.<>c__DisplayClass8_0`1.<<ExecuteInTransactionAsync>b__0>d.MoveNext() in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaTransactionService.cs:line 86
--- End of stack trace from previous location ---
   at MuhasebeStokWebApp.Services.ExceptionHandlingService.HandleExceptionAsync[T](Func`1 func, String logContext, Object[] logParams) in D:\cursor-workspace\MuhasebeStokWebApp\Services\ExceptionHandlingService.cs:line 146
2025-05-12 15:13:43.403 +03:00 [INF] Fatura bilgileri güncellendi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 15:13:43.404 +03:00 [INF] FIFO kayıtları iptal edilmeye çalışılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 15:13:43.405 +03:00 [INF] FifoKayitlariniIptalEt - Mevcut transaction kullanılıyor: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47
2025-05-12 15:13:43.432 +03:00 [WRN] İptal edilecek FIFO kaydı bulunamadı: ReferansID=1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47, ReferansTuru=Fatura
2025-05-12 15:13:43.433 +03:00 [INF] İlişkili FIFO kayıtları iptal edildi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 15:13:43.461 +03:00 [INF] İlişkili stok hareketleri silindi. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 15:13:43.490 +03:00 [INF] Cari hareket silindi. CariHareketID: "2cb7fe3e-7c75-49dc-9192-29975c14a863"
2025-05-12 15:13:43.525 +03:00 [INF] Eski fatura detayları silindi. Toplam 1 detay. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 15:13:43.527 +03:00 [INF] Yeni fatura detayı eklendi. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d"
2025-05-12 15:13:43.528 +03:00 [INF] Stok hareketi oluşturuldu. UrunID: "2216d3ad-9370-49a9-847e-c374b130978d", Miktar: 15
2025-05-12 15:13:43.529 +03:00 [INF] StokCikisiYap başladı: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15, Hareket Tipi Cikis
2025-05-12 15:13:43.530 +03:00 [INF] StokCikisiYap - Mevcut transaction kullanılıyor: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15
2025-05-12 15:13:43.643 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'MuhasebeStokWebApp.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:98bf5c0f-3cb7-46c6-a1c5-c3be3452534e
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:98bf5c0f-3cb7-46c6-a1c5-c3be3452534e
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-05-12 15:13:43.654 +03:00 [ERR] FIFO işlemi sırasında beklenmeyen hata: StokFifoID: 85259f4b-9668-46b6-8e2e-41955eeaaa19, Hata: An error occurred while saving the entity changes. See the inner exception for details.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:98bf5c0f-3cb7-46c6-a1c5-c3be3452534e
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
2025-05-12 15:13:43.664 +03:00 [ERR] Stok çıkışı sırasında hata oluştu: Ürün 2216d3ad-9370-49a9-847e-c374b130978d, Miktar 15
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:98bf5c0f-3cb7-46c6-a1c5-c3be3452534e
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
2025-05-12 15:13:43.674 +03:00 [ERR] Fatura ve ilişkili kayıtlar güncellenirken hata. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47", Hata: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:98bf5c0f-3cb7-46c6-a1c5-c3be3452534e
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
2025-05-12 15:13:43.714 +03:00 [INF] Fatura güncelleme işlemi geri alındı. FaturaID: "1bffa8ed-6abd-4c9e-ac6f-209efc0f1f47"
2025-05-12 15:13:43.715 +03:00 [ERR] Fatura güncelleme hatası
System.Exception: Stok çıkışı işlemi başarısız oldu: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): NULL değeri 'MuhasebeStokDB.dbo.FaturaDetaylari' tablosunun 'SatirKdvToplam' sütununa eklemez; sütun null değerlere izin vermiyor. INSERT başarısız.
   at Microsoft.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreResults(Boolean& moreResults)
   at Microsoft.Data.SqlClient.SqlDataReader.TryNextResult(Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.NextResultAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:98bf5c0f-3cb7-46c6-a1c5-c3be3452534e
Error Number:515,State:2,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at MuhasebeStokWebApp.Services.StokFifoService.ProcessFifoEntryWithRetry(StokFifo fifoEntry, Func`2 processAction, Int32 maxRetries) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 1329
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 493
   --- End of inner exception stack trace ---
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 650
   at MuhasebeStokWebApp.Services.StokFifoService.StokCikisiYap(Guid urunID, Decimal miktar, StokHareketTipi hareketTipi, Nullable`1 referansID, String aciklama, String paraBirimi, Boolean useBatch, Nullable`1 dovizKuru) in D:\cursor-workspace\MuhasebeStokWebApp\Services\StokFifoService.cs:line 659
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 508
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 584
   at MuhasebeStokWebApp.Services.FaturaOrchestrationService.UpdateFaturaWithRelations(Guid id, FaturaEditViewModel viewModel, Nullable`1 currentUserId) in D:\cursor-workspace\MuhasebeStokWebApp\Services\FaturaOrchestrationService.cs:line 592
   at MuhasebeStokWebApp.Controllers.FaturaController.Edit(Guid id, FaturaEditViewModel viewModel) in D:\cursor-workspace\MuhasebeStokWebApp\Controllers\FaturaController.cs:line 620
2025-05-12 15:16:05.756 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:16:05.802 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:21:05.806 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:21:05.836 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:26:05.850 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:26:05.881 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:31:05.868 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:31:06.015 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:34:23.536 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 15:34:23.585 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 15:34:23.612 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 15:34:23.656 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:34:23.711 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:34:23.743 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:34:23.789 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:34:23.879 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:34:23.881 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:34:23.925 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:34:35.780 +03:00 [INF] Kur değeri hesaplandı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 15:35:00.496 +03:00 [INF] Fatura oluşturma işlemi başlatıldı: FaturaNumarasi=FTR-250512-003, FaturaTuru=1, CariID="fdc7e9f0-d79f-4008-834e-32856a40c18b"
2025-05-12 15:35:00.522 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:35:00.548 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:35:00.575 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:35:00.601 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:35:00.691 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:35:00.692 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:35:00.720 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:35:00.747 +03:00 [WRN] Fatura oluşturma işleminde doğrulama hatası. FaturaNumarasi=FTR-250512-003, Hatalar=The value '154.793,40' is not valid for Dövizli KDV Toplam.
2025-05-12 15:35:10.412 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 15:35:10.439 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 15:35:10.466 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 15:35:10.494 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:35:10.522 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:35:10.549 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:35:10.576 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:35:10.665 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:35:10.666 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:35:10.693 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:35:15.808 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 15:35:15.834 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 15:35:15.860 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 15:35:15.888 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:35:15.915 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:35:15.943 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:35:15.969 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:35:16.045 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:35:16.047 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:35:16.073 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:35:21.593 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 15:35:21.622 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 15:35:21.652 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 15:35:21.681 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:35:21.709 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:35:21.740 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:35:21.768 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:35:21.852 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:35:21.853 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:35:21.882 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:35:40.007 +03:00 [INF] Kur değeri önbellekten alındı: UZS -> USD, Değer: 0.0000775226832727903141733102
2025-05-12 15:35:54.917 +03:00 [INF] Fatura oluşturma işlemi başlatıldı: FaturaNumarasi=FTR-250512-003, FaturaTuru=1, CariID="fdc7e9f0-d79f-4008-834e-32856a40c18b"
2025-05-12 15:35:54.947 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:35:54.975 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:35:55.003 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:35:55.032 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:35:55.116 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:35:55.118 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:35:55.147 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:35:55.176 +03:00 [WRN] Fatura oluşturma işleminde doğrulama hatası. FaturaNumarasi=FTR-250512-003, Hatalar=The value '773.967,02' is not valid for Dövizli KDV Toplam.
2025-05-12 15:36:06.021 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:36:06.051 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:36:44.227 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 15:36:44.258 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 15:36:44.286 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 15:36:44.315 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:36:44.346 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:36:44.379 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:36:44.407 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:36:44.493 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:36:44.494 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:36:44.523 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:37:30.814 +03:00 [INF] Fatura oluşturma sayfası yükleniyor: Kullanıcı=admin
2025-05-12 15:37:30.845 +03:00 [INF] Yeni numara oluşturuldu: FTR-250512-003
2025-05-12 15:37:30.876 +03:00 [INF] Yeni numara oluşturuldu: SIP-250512-003
2025-05-12 15:37:30.903 +03:00 [INF] Cari listesi yüklendi, toplam 2 adet cari bulundu.
2025-05-12 15:37:30.932 +03:00 [INF] Sözleşme listesi yüklendi, toplam 0 adet sözleşme bulundu.
2025-05-12 15:37:30.962 +03:00 [INF] Ürün listesi yüklendi, toplam 2 adet ürün bulundu.
2025-05-12 15:37:30.991 +03:00 [INF] Depo listesi yüklendi, toplam 1 adet depo bulundu.
2025-05-12 15:37:31.071 +03:00 [INF] Birim sayısı: Aktif=1, Pasif=0, Silinmiş=0
2025-05-12 15:37:31.072 +03:00 [INF] Ürün select list oluşturuldu, toplam 2 adet öğe içeriyor.
2025-05-12 15:37:31.102 +03:00 [INF] Para birimi listesi yüklendi, toplam 2 adet para birimi bulundu.
2025-05-12 15:41:06.065 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:41:06.099 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:44:43.886 +03:00 [INF] Giriş denemesi: admin
2025-05-12 15:44:44.142 +03:00 [INF] Admin kullanıcısı başarıyla giriş yaptı: admin
2025-05-12 15:44:44.142 +03:00 [INF] Admin session oluşturuldu: UserID=9e6fc203-37eb-49a7-a470-1551f7bec8b8, UserName=admin
2025-05-12 15:44:44.143 +03:00 [INF] Yönlendirme adresi: /Fatura/Edit/f01cfc7e-5cb3-42c0-911b-98634d9733b4
2025-05-12 15:44:44.144 +03:00 [INF] Admin kullanıcısı /Fatura/Edit/f01cfc7e-5cb3-42c0-911b-98634d9733b4 adresine yönlendiriliyor
2025-05-12 15:46:06.097 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:46:06.125 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:47:21.888 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 15:47:23.017 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 15:47:23.149 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 15:47:23.152 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:47:23.258 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:52:23.270 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:52:23.306 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
2025-05-12 15:54:43.557 +03:00 [INF] Veritabanına bağlantı başarılı. Migrationlar uygulanıyor...
2025-05-12 15:54:44.641 +03:00 [INF] Veritabanı işlemleri başarıyla tamamlandı.
2025-05-12 15:54:44.830 +03:00 [INF] Todo Hatırlatıcı Servisi başlatıldı.
2025-05-12 15:54:44.834 +03:00 [INF] Yaklaşan hatırlatıcılar kontrol ediliyor...
2025-05-12 15:54:44.998 +03:00 [INF] Bekleyen hatırlatma bulunamadı.
