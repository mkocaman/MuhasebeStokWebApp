@using System.Linq
@model MuhasebeStokWebApp.ViewModels.Fatura.FaturaEditViewModel
@{
    ViewData["Title"] = "Fatura Düzenle";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@functions {
    public static string FormatDecimal(decimal value)
    {
        return value.ToString("N2", new System.Globalization.CultureInfo("tr-TR"));
    }
}

<style>
    /* Tablo hücrelerinin alt alta gelmesini önlemek için */
    #kalemlerTable tr {
        display: table-row !important;
    }
    
    #kalemlerTable td, #kalemlerTable th {
        display: table-cell !important;
        vertical-align: middle !important;
    }
    
    /* Select2 dropdown'ın tablo içinde düzgün görünmesi için */
    .select2-container {
        width: 100% !important;
    }
    
    /* Mobil görünümde yatay kaydırma */
    .table-responsive {
        overflow-x: auto;
    }
    
    /* Tablo hücrelerinin genişliğini korumak için */
    #kalemlerTable th, #kalemlerTable td {
        white-space: nowrap;
    }
</style>

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Fatura Düzenle</h4>
                <a asp-action="Index" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Listeye Dön
                </a>
            </div>
        </div>
        <div class="card-body">
            <form asp-action="Edit" id="faturaForm" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input type="hidden" asp-for="FaturaID" />
                
                <!-- 1. Satır: Fatura No, Sipariş No, Fatura Tarihi, Vade Tarihi -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="FaturaNumarasi" class="control-label">Fatura Numarası</label>
                            <input asp-for="FaturaNumarasi" class="form-control" />
                            <span asp-validation-for="FaturaNumarasi" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="SiparisNumarasi" class="control-label">Sipariş Numarası</label>
                            <input asp-for="SiparisNumarasi" class="form-control" />
                            <span asp-validation-for="SiparisNumarasi" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="FaturaTarihi" class="control-label">Fatura Tarihi</label>
                            <input asp-for="FaturaTarihi" class="form-control" type="date" />
                            <span asp-validation-for="FaturaTarihi" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="VadeTarihi" class="control-label">Vade Tarihi</label>
                            <input asp-for="VadeTarihi" class="form-control" type="date" />
                            <span asp-validation-for="VadeTarihi" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <!-- 2. Satır: Cari, Fatura Türü, Döviz Türü, Döviz Kuru -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="CariID" class="control-label">Cari</label>
                            <div class="input-group">
                                <select asp-for="CariID" class="form-control select2" asp-items="ViewBag.Cariler">
                                    <option value="">-- Cari Seçiniz --</option>
                                </select>
                                @if (ViewBag.CariSilindi != null && ViewBag.CariSilindi)
                                {
                                    <div class="input-group-append">
                                        <span class="input-group-text bg-danger text-white">Silindi</span>
                                    </div>
                                }
                            </div>
                            <span asp-validation-for="CariID" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="FaturaTuruID" class="control-label">Fatura Türü</label>
                            <select asp-for="FaturaTuruID" class="form-control select2" asp-items="ViewBag.FaturaTurleri">
                                <option value="">-- Fatura Türü Seçiniz --</option>
                            </select>
                            <span asp-validation-for="FaturaTuruID" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DovizTuru" class="control-label">Döviz Türü</label>
                            <select asp-for="DovizTuru" class="form-control" id="dovizTuruSelect">
                                @foreach (var item in Model.DovizListesi)
                                {
                                    if (Model.DovizTuru == item.Value)
                                    {
                                        <option value="@item.Value" selected>@item.Text</option>
                                    }
                                    else 
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="DovizTuru" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="DovizKuru" class="control-label">Döviz Kuru</label>
                            <div class="input-group">
                                <input asp-for="DovizKuru" id="DovizKuru" class="form-control" type="number" step="0.0001" min="0.0001" />
                                <button type="button" class="btn btn-info" id="btnGetirKur">
                                    <i class="fas fa-sync"></i> Kur Getir
                                </button>
                            </div>
                            <span asp-validation-for="DovizKuru" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <!-- 3. Satır: Resmi Fatura mı? Ve Sözleşme (Koşullu) -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="form-group">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" asp-for="ResmiMi" id="resmiMiCheck" />
                                <label class="form-check-label" asp-for="ResmiMi">Resmi Fatura mı?</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="form-group" id="sozlesmeDiv" style="display: @(Model.ResmiMi ? "block" : "none");">
                            <label for="SozlesmeID" class="control-label">Sözleşme</label>
                            <select asp-for="SozlesmeID" class="form-control select2" asp-items="ViewBag.Sozlesmeler">
                                <option value="">-- Sözleşme Seçiniz --</option>
                            </select>
                            <span asp-validation-for="SozlesmeID" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Fatura Kalemleri -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Fatura Kalemleri</h5>
                        <button type="button" class="btn btn-primary btn-sm" id="btnAddKalem">
                            <i class="fa fa-plus"></i> Kalem Ekle
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="kalemlerTable">
                                <thead class="bg-primary text-white">
                                    <tr>
                                        <th style="color: black;">Ürün</th>
                                        <th style="width: 100px; color: black;">Miktar</th>
                                        <th style="width: 100px; color: black;">Birim</th>
                                        <th style="width: 120px; color: black;">Birim Fiyat</th>
                                        <th style="width: 80px; color: black;">KDV %</th>
                                        <th style="width: 80px; color: black;">İndirim %</th>
                                        <th style="width: 120px; color: black;">Tutar</th>
                                        <th style="width: 120px; color: black;">KDV Tutarı</th>
                                        <th style="width: 120px; color: black;">Net Tutar</th>
                                        <th style="width: 80px; color: black;">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="kalemlerBody">
                                    @if (Model.FaturaKalemleri != null && Model.FaturaKalemleri.Count > 0)
                                    {
                                        @for (int i = 0; i < Model.FaturaKalemleri.Count; i++)
                                        {
                                            <tr class="kalem-row">
                                                <td>
                                                    <input type="hidden" name="FaturaKalemleri[@i].KalemID" value="@Model.FaturaKalemleri[i].KalemID" />
                                                    <select name="FaturaKalemleri[@i].UrunID" class="form-control urun-select" required>
                                                        <option value="">-- Ürün Seçiniz --</option>
                                                        @foreach (var item in ViewBag.Urunler)
                                                        {
                                                            @if (Model.FaturaKalemleri[i].UrunID.ToString() == item.Value)
                                                            {
                                                                <option value="@item.Value" selected>@item.Text</option>
                                                            }
                                                            else
                                                            {
                                                                <option value="@item.Value">@item.Text</option>
                                                            }
                                                        }
                                                    </select>
                                                    <input type="hidden" name="FaturaKalemleri[@i].UrunAdi" class="urun-adi" value="@Model.FaturaKalemleri[i].UrunAdi" />
                                                </td>
                                                <td>
                                                    <input type="number" name="FaturaKalemleri[@i].Miktar" class="form-control miktar" value="@Model.FaturaKalemleri[i].Miktar" min="0.01" step="0.01" required />
                                                </td>
                                                <td>
                                                    <input type="text" name="FaturaKalemleri[@i].Birim" class="form-control birim" value="@Model.FaturaKalemleri[i].Birim" readonly />
                                                </td>
                                                <td>
                                                    <input type="number" name="FaturaKalemleri[@i].BirimFiyat" class="form-control birim-fiyat" value="@Model.FaturaKalemleri[i].BirimFiyat" min="0.01" step="0.01" required />
                                                </td>
                                                <td>
                                                    <input type="number" name="FaturaKalemleri[@i].KdvOrani" class="form-control kdv-orani" value="@Model.FaturaKalemleri[i].KdvOrani" min="0" max="100" />
                                                </td>
                                                <td>
                                                    <input type="number" name="FaturaKalemleri[@i].IndirimOrani" class="form-control indirim-orani" value="@Model.FaturaKalemleri[i].IndirimOrani" min="0" max="100" />
                                                </td>
                                                <td>
                                                    <input type="number" name="FaturaKalemleri[@i].Tutar" class="form-control tutar" value="@Model.FaturaKalemleri[i].Tutar" readonly />
                                                </td>
                                                <td>
                                                    <input type="number" name="FaturaKalemleri[@i].KdvTutari" class="form-control kdv-tutari" value="@Model.FaturaKalemleri[i].KdvTutari" readonly />
                                                </td>
                                                <td>
                                                    <input type="number" name="FaturaKalemleri[@i].NetTutar" class="form-control net-tutar" value="@Model.FaturaKalemleri[i].NetTutar" readonly />
                                                </td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-danger btn-sm btn-remove-kalem">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                    <input type="hidden" name="FaturaKalemleri.Index" value="@i" />
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Fatura Toplamları ve Açıklama -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Aciklama" class="control-label">Açıklama</label>
                            <textarea asp-for="Aciklama" class="form-control" rows="7"></textarea>
                            <span asp-validation-for="Aciklama" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th style="width: 200px;">Ara Toplam</th>
                                        <td class="text-right">
                                            <input id="AraToplam" name="AraToplam" class="form-control text-right" readonly />
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>KDV Tutarı</th>
                                        <td class="text-right">
                                            <input id="KdvTutari" name="KdvToplam" class="form-control text-right" readonly />
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>İndirim Tutarı</th>
                                        <td class="text-right">
                                            <input id="toplamIndirimTutari" class="form-control text-right" readonly />
                                        </td>
                                    </tr>
                                    <tr class="table-primary">
                                        <th>Genel Toplam</th>
                                        <td class="text-right">
                                            <input id="GenelToplam" name="GenelToplam" class="form-control text-right font-weight-bold" readonly />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="row mt-4">
                    <div class="col-12 text-right">
                        <button type="submit" id="submitBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Faturayı Kaydet
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kalem Template (Gizli) -->
<script type="text/template" id="kalemTemplate">
    <tr class="kalem-row">
        <td>
            <select name="FaturaKalemleri[{index}].UrunID" class="form-control urun-select" required>
                <option value="">-- Ürün Seçiniz --</option>
                @if (ViewBag.Urunler != null)
                {
                    foreach (var urun in ViewBag.Urunler)
                    {
                        <option value="@urun.Value" data-birim="@(ViewBag.UrunBirimBilgileri != null && ViewBag.UrunBirimBilgileri.ContainsKey(urun.Value) ? ViewBag.UrunBirimBilgileri[urun.Value] : "Adet")">@urun.Text</option>
                    }
                }
            </select>
            <input type="hidden" name="FaturaKalemleri[{index}].UrunAdi" class="urun-adi" />
        </td>
        <td>
            <input type="number" name="FaturaKalemleri[{index}].Miktar" class="form-control miktar" value="1" min="0.01" step="0.01" required />
        </td>
        <td>
            <input type="text" name="FaturaKalemleri[{index}].Birim" class="form-control birim" readonly />
        </td>
        <td>
            <input type="number" name="FaturaKalemleri[{index}].BirimFiyat" class="form-control birim-fiyat" value="0" min="0.01" step="0.01" required />
        </td>
        <td>
            <input type="number" name="FaturaKalemleri[{index}].KdvOrani" class="form-control kdv-orani" value="0" min="0" max="100" />
        </td>
        <td>
            <input type="number" name="FaturaKalemleri[{index}].IndirimOrani" class="form-control indirim-orani" value="0" min="0" max="100" />
        </td>
        <td>
            <input type="number" name="FaturaKalemleri[{index}].Tutar" class="form-control tutar" value="0" readonly />
        </td>
        <td>
            <input type="number" name="FaturaKalemleri[{index}].KdvTutari" class="form-control kdv-tutari" value="0" readonly />
        </td>
        <td>
            <input type="number" name="FaturaKalemleri[{index}].NetTutar" class="form-control net-tutar" value="0" readonly />
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm btn-remove-kalem">
                <i class="fa fa-trash"></i>
            </button>
            <input type="hidden" name="FaturaKalemleri.Index" value="{index}" />
        </td>
    </tr>
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <!-- Select2 kütüphanesi -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        $(document).ready(function () {
            var kalemIndex = @(Model.FaturaKalemleri?.Count ?? 0);
            
            // Select2 entegrasyonu
            try {
                $('.select2').select2();
            } catch (e) {
                console.error("Select2 yüklenemedi:", e);
            }

            // İlk yükleme anında mevcut kalemlerin toplamlarını hesapla
            updateAllTotals();

            // Güncel kur getir
            $("#btnGetirKur").click(function() {
                var dovizKodu = $("#dovizTuruSelect").val();
                if (dovizKodu === "TRY") {
                    $("#DovizKuru").val(1);
                    return;
                }
                
                try {
                    $.ajax({
                        url: "/ParaBirimi/GetLatestExchangeRateByKod",
                        type: "GET",
                        data: { kod: dovizKodu },
                        success: function(data) {
                            if (data && data.kur) {
                                $("#DovizKuru").val(data.kur.toFixed(4));
                            } else {
                                alert("Kur bilgisi bulunamadı. Lütfen manuel olarak giriniz.");
                                $("#DovizKuru").val(1);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Kur bilgisi alınırken hata:", error);
                            alert("Kur bilgisi alınırken bir hata oluştu. Varsayılan değer 1 olarak ayarlandı.");
                            $("#DovizKuru").val(1);
                        }
                    });
                } catch (e) {
                    console.error("Kur getirme işleminde hata:", e);
                    $("#DovizKuru").val(1);
                }
            });
            
            // Döviz türü değiştiğinde
            $("#dovizTuruSelect").change(function() {
                var dovizKodu = $(this).val();
                if (dovizKodu === "TRY") {
                    $("#DovizKuru").val(1);
                } else {
                    $("#btnGetirKur").click();
                }
            });
            
            // Resmi Fatura mı? checkbox değişiminde
            $("#resmiMiCheck").change(function() {
                var isResmi = $(this).is(":checked");
                
                if(isResmi) {
                    $("#sozlesmeDiv").show();
                    
                    // Tüm satırlarda KDV oranlarını güncelle
                    $(".kalem-row").each(function() {
                        // Eğer KDV oranı sıfır ise ve fatura resmi ise KDV'yi 12 yap
                        var kdvOrani = parseFloat($(this).find(".kdv-orani").val());
                        if (kdvOrani === 0) {
                            $(this).find(".kdv-orani").val(12);
                        }
                        // Her satır için hesaplamayı güncelle
                        calculateRowTotals($(this));
                    });
                } else {
                    $("#sozlesmeDiv").hide();
                    $("#SozlesmeID").val('').trigger('change');
                    
                    // KDV oranlarını sıfırlama ihtiyaca bağlı olarak kaldırıldı
                }
                
                // Toplamları güncelle
                updateAllTotals();
            });
            
            // Yeni kalem ekle
            $("#btnAddKalem").click(function() {
                var template = $("#kalemTemplate").html().replace(/\{index\}/g, kalemIndex);
                $("#kalemlerBody").append(template);
                
                // Select2'yi yeni eklenen satırdaki select elemana uygula
                try {
                    $("#kalemlerBody").find(".urun-select").last().select2();
                } catch (e) {
                    console.error("Select2 yüklenemedi:", e);
                }
                
                // Event listeners ekle
                attachEventListeners();
                
                kalemIndex++;
            });
            
            // Mevcut event listener'ları ekle
            attachEventListeners();
            
            // Event listener'ları ekle
            function attachEventListeners() {
                // Ürün seçildiğinde
                $(".urun-select").off("change").on("change", function() {
                    var row = $(this).closest(".kalem-row");
                    var urunID = $(this).val();
                    var urunText = $(this).find("option:selected").text();
                    var birim = $(this).find("option:selected").data("birim") || "Adet";
                    
                    // Ürün adını hidden input'a kaydet
                    row.find(".urun-adi").val(urunText);
                    
                    // Birimi input'a kaydet
                    row.find(".birim").val(birim);
                    
                    if (urunID) {
                        // Ürün bilgilerini getir
                        $.ajax({
                            url: "/Fatura/GetUrunBilgileri",
                            type: "GET",
                            data: { id: urunID },
                            success: function(data) {
                                if (data) {
                                    row.find(".birim").val(data.birim);
                                    
                                    // Boşsa eğer birim fiyatı doldur
                                    var birimFiyat = row.find(".birim-fiyat").val();
                                    if (!birimFiyat || birimFiyat == 0) {
                                        row.find(".birim-fiyat").val(data.birimFiyat);
                                    }
                                    
                                    // Boşsa eğer KDV oranını doldur
                                    var kdvOrani = row.find(".kdv-orani").val();
                                    if (!kdvOrani || kdvOrani == 0) {
                                        var newKdvOrani = data.kdvOrani;
                                        // Eğer resmi faturaysa ve KDV sıfırsa, KDV'yi 12 yap
                                        if ($("#resmiMiCheck").is(":checked") && newKdvOrani == 0) {
                                            newKdvOrani = 12;
                                        }
                                        row.find(".kdv-orani").val(newKdvOrani);
                                    }
                                    
                                    // Hesaplamaları güncelle
                                    calculateRowTotals(row);
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error("Ürün bilgileri alınamadı:", error);
                            }
                        });
                    } else {
                        // Ürün seçilmediğinde varsayılan değerler
                        row.find(".birim").val("Adet");
                        // Hesaplamaları güncelle
                        calculateRowTotals(row);
                    }
                });
                
                // Miktar, birim fiyat, KDV oranı veya indirim oranı değiştiğinde
                $(".miktar, .birim-fiyat, .kdv-orani, .indirim-orani").off("input").on("input", function() {
                    var row = $(this).closest(".kalem-row");
                    calculateRowTotals(row);
                });
                
                // Kalem silme
                $(".btn-remove-kalem").off("click").on("click", function() {
                    $(this).closest(".kalem-row").remove();
                    updateAllTotals();
                });
            }
            
            // Bir satırın toplamlarını hesapla
            function calculateRowTotals(row) {
                var miktar = parseFloat(row.find(".miktar").val()) || 0;
                var birimFiyat = parseFloat(row.find(".birim-fiyat").val()) || 0;
                var kdvOrani = parseFloat(row.find(".kdv-orani").val()) || 0;
                var indirimOrani = parseFloat(row.find(".indirim-orani").val()) || 0;
                
                // İndirim tutarı
                var indirimTutari = (miktar * birimFiyat) * (indirimOrani / 100);
                
                // KDV'siz tutar (indirim düşülmüş)
                var tutar = (miktar * birimFiyat) - indirimTutari;
                
                // KDV tutarı
                var kdvTutari = tutar * (kdvOrani / 100);
                
                // Net tutar (KDV dahil)
                var netTutar = tutar + kdvTutari;
                
                // Değerleri yaz
                row.find(".tutar").val(tutar.toFixed(2));
                row.find(".kdv-tutari").val(kdvTutari.toFixed(2));
                row.find(".net-tutar").val(netTutar.toFixed(2));
                
                // Tüm toplamları güncelle
                updateAllTotals();
            }
            
            // Tüm toplamları güncelle
            function updateAllTotals() {
                var araToplam = 0;
                var kdvToplam = 0;
                var indirimToplam = 0;
                var genelToplam = 0;
                
                // Tüm satırları dolaş
                $(".kalem-row").each(function() {
                    var miktar = parseFloat($(this).find(".miktar").val()) || 0;
                    var birimFiyat = parseFloat($(this).find(".birim-fiyat").val()) || 0;
                    var kdvOrani = parseFloat($(this).find(".kdv-orani").val()) || 0;
                    var indirimOrani = parseFloat($(this).find(".indirim-orani").val()) || 0;
                    
                    var satırIndirimTutari = (miktar * birimFiyat) * (indirimOrani / 100);
                    var satırTutar = (miktar * birimFiyat) - satırIndirimTutari;
                    var satırKdvTutari = satırTutar * (kdvOrani / 100);
                    var satırNetTutar = satırTutar + satırKdvTutari;
                    
                    araToplam += satırTutar;
                    kdvToplam += satırKdvTutari;
                    indirimToplam += satırIndirimTutari;
                    genelToplam += satırNetTutar;
                });
                
                // Toplamları yaz
                $("#AraToplam").val(araToplam.toFixed(2));
                $("#KdvTutari").val(kdvToplam.toFixed(2));
                $("#toplamIndirimTutari").val(indirimToplam.toFixed(2));
                $("#GenelToplam").val(genelToplam.toFixed(2));
            }
            
            // Form submit kontrolü
            $("#faturaForm").submit(function(e) {
                var kalemSayisi = $(".kalem-row").length;
                if (kalemSayisi === 0) {
                    e.preventDefault();
                    alert("Lütfen en az bir fatura kalemi ekleyin.");
                    return false;
                }
                
                // Form submit edilmeden önce toplamları güncelle
                updateAllTotals();
                return true;
            });
        });
    </script>
} 