@model dynamic
@{
    ViewData["Title"] = "Anasayfa";
    ViewData["ActiveMenu"] = "Anasayfa";
}

@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        <strong>Hata!</strong> @ViewBag.ErrorMessage
    </div>
}

<div class="container-fluid">
    <!-- Finansal Durum Kartları -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Toplam Gelir</h6>
                            <h4 class="mb-0">@((ViewBag.TotalRevenue != null ? Convert.ToDecimal(ViewBag.TotalRevenue) : 0).ToString("N2")) TL</h4>
                        </div>
                        <div class="avatar">
                            <div class="avatar-title rounded bg-light-primary">
                                <i class="material-icons">trending_up</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Toplam Gider</h6>
                            <h4 class="mb-0">@((ViewBag.TotalExpense != null ? Convert.ToDecimal(ViewBag.TotalExpense) : 0).ToString("N2")) TL</h4>
                        </div>
                        <div class="avatar">
                            <div class="avatar-title rounded bg-light-danger">
                                <i class="material-icons">trending_down</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Net Kar</h6>
                            <h4 class="mb-0">@(((ViewBag.TotalRevenue != null ? Convert.ToDecimal(ViewBag.TotalRevenue) : 0) - (ViewBag.TotalExpense != null ? Convert.ToDecimal(ViewBag.TotalExpense) : 0)).ToString("N2")) TL</h4>
                        </div>
                        <div class="avatar">
                            <div class="avatar-title rounded bg-light-success">
                                <i class="material-icons">account_balance</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="text-muted mb-2">Toplam İşlem</h6>
                            <h4 class="mb-0">@((ViewBag.MonthlyData != null ? ViewBag.MonthlyData.Count : 0) + (ViewBag.MonthlyExpenses != null ? ViewBag.MonthlyExpenses.Count : 0))</h4>
                        </div>
                        <div class="avatar">
                            <div class="avatar-title rounded bg-light-info">
                                <i class="material-icons">receipt_long</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grafikler -->
    <div class="row">
        <!-- Aylık Gelir-Gider Grafiği -->
        <div class="col-xl-8">
            <div class="card">
                <div class="card-header">
                    <h5>Aylık Gelir-Gider Grafiği</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Kategori Bazlı Gelir Grafiği -->
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h5>Kategori Bazlı Gelir</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Son 6 Ay Trendi -->
        <div class="col-xl-8">
            <div class="card">
                <div class="card-header">
                    <h5>Son 6 Ay Gelir-Gider Trendi</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- En Çok Satılan Ürünler -->
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h5>En Çok Satılan Ürünler</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ürün</th>
                                    <th>Satış</th>
                                    <th>Miktar</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ViewBag.TopProducts != null)
                                {
                                    foreach (var product in ViewBag.TopProducts)
                                    {
                                        <tr>
                                            <td>@product.ProductName</td>
                                            <td>@product.TotalSales.ToString("N2") TL</td>
                                            <td>@product.TotalQuantity.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="3" class="text-center">Veri bulunamadı</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Veri doğrulama fonksiyonu
        function safeJsonParse(jsonStr, defaultValue) {
            try {
                if (!jsonStr) return defaultValue;
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error("JSON parse hatası:", e);
                return defaultValue;
            }
        }
        
        // Null güvenli veri alma
        var days = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.Days))', []);
        var revenues = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.Revenues))', []);
        var expenses = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.Expenses))', []);
        var categories = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.Categories))', []);
        var categoryRevenues = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.CategoryRevenues))', []);
        var last6MonthLabels = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.Last6MonthLabels))', []);
        var trendRevenues = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.TrendRevenues))', []);
        var trendExpenses = safeJsonParse('@Html.Raw(Json.Serialize(ViewBag.TrendExpenses))', []);
        
        // Aylık Gelir-Gider Grafiği
        var monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: days,
                datasets: [{
                    label: 'Gelir',
                    data: revenues,
                    borderColor: '#4CAF50',
                    tension: 0.1
                }, {
                    label: 'Gider',
                    data: expenses,
                    borderColor: '#F44336',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                            }
                        }
                    }
                }
            }
        });

        // Kategori Bazlı Gelir Grafiği
        var categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: categoryRevenues,
                    backgroundColor: [
                        '#4CAF50',
                        '#2196F3',
                        '#FFC107',
                        '#9C27B0',
                        '#FF5722',
                        '#795548',
                        '#607D8B'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });

        // Son 6 Ay Trendi
        var trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels: last6MonthLabels,
                datasets: [{
                    label: 'Gelir',
                    data: trendRevenues,
                    backgroundColor: '#4CAF50'
                }, {
                    label: 'Gider',
                    data: trendExpenses,
                    backgroundColor: '#F44336'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                            }
                        }
                    }
                }
            }
        });
    </script>
}
