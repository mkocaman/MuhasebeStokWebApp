@model List<MuhasebeStokWebApp.ViewModels.Kasa.KasaHareketViewModel>
@{
    ViewData["Title"] = "Kasa Hareketleri";
    var kasa = ViewBag.Kasa as MuhasebeStokWebApp.ViewModels.Kasa.KasaViewModel;
}

<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h3>Kasa Hareketleri</h3>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/"><i data-feather="home"></i></a></li>
                    <li class="breadcrumb-item"><a asp-controller="Kasa" asp-action="Index">Kasalar</a></li>
                    <li class="breadcrumb-item active">Kasa Hareketleri</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-0">@(kasa?.KasaAdi ?? "Kasa Bilgisi Bulunamadı")</h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#yeniKasaHareketModal" data-id="@kasa?.KasaID">
                                <i class="fas fa-plus"></i> Yeni Hareket
                            </button>
                            <a asp-action="Edit" asp-route-id="@(kasa?.KasaID ?? Guid.Empty)" class="btn btn-sm btn-light">
                                <i class="fas fa-edit"></i> Kasayı Düzenle
                            </a>
                            <a asp-action="Index" class="btn btn-sm btn-light">
                                <i class="fas fa-arrow-left"></i> Kasalara Dön
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="info-box bg-light p-3">
                                <h6>Kasa Türü</h6>
                                <h4>@(kasa?.KasaTuru ?? "Belirtilmemiş")</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-box bg-light p-3">
                                <h6>Açılış Bakiyesi</h6>
                                <h4>@(kasa?.AcilisBakiye.ToString("N2") ?? "0.00") @(kasa?.ParaBirimi ?? "TRY")</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-box bg-light p-3">
                                <h6>Güncel Bakiye</h6>
                                <h4 class="@(kasa != null && kasa.GuncelBakiye >= 0 ? "text-success" : "text-danger")">
                                    @(kasa?.GuncelBakiye.ToString("N2") ?? "0.00") @(kasa?.ParaBirimi ?? "TRY")
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Kasa Hareketleri</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="hareketlerTable" class="table table-bordered table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>İşlem No</th>
                                    <th>Tarih</th>
                                    <th>Hareket Türü</th>
                                    <th>Tutar</th>
                                    <th>Referans No</th>
                                    <th>Referans Türü</th>
                                    <th>Açıklama</th>
                                    <th>Cari</th>
                                    <th width="150">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Hareketler DataTables tarafından doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yeni Kasa Hareketi Modal -->
<div class="modal fade" id="yeniKasaHareketModal" tabindex="-1" aria-labelledby="yeniKasaHareketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="yeniKasaHareketContainer">
                <div class="modal-body text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTables başlat
            var table = $('#hareketlerTable').DataTable({
                "processing": true,
                "serverSide": true,
                "filter": true,
                "orderMulti": false,
                "pageLength": 10,
                "language": {
                    "url": "/lib/datatables/tr.json"
                },
                "ajax": {
                    "url": "@Url.Action("GetKasaHareketler", "Kasa", new { id = kasa?.KasaID })",
                    "type": "POST",
                    "datatype": "json"
                },
                "columnDefs": [
                    {
                        "targets": 3,
                        "className": "text-end",
                        "render": function (data, type, row) {
                            var islemTuru = row.hareketTuru;
                            var tutar = parseFloat(data).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            var paraBirimi = '@(kasa?.ParaBirimi ?? "TRY")';
                            
                            if (islemTuru === "Giriş" || islemTuru === "Açılış Bakiyesi" || islemTuru === "Bakiye Artışı") {
                                return `<span class="text-success">+${tutar} ${paraBirimi}</span>`;
                            } else {
                                return `<span class="text-danger">-${tutar} ${paraBirimi}</span>`;
                            }
                        }
                    },
                    {
                        "targets": -1,
                        "data": null,
                        "orderable": false,
                        "searchable": false,
                        "render": function (data, type, row) {
                            var referansTuru = row.referansTuru;
                            var isManuel = referansTuru === "Normal";
                            var detayBtn = `<a href="/Kasa/HareketDetay/${row.kasaHareketID}" class="btn btn-sm btn-info me-1" title="Detay"><i class="fas fa-info-circle"></i></a>`;
                            var duzenleBtn = isManuel ? `<a href="/Kasa/HareketDuzenle/${row.kasaHareketID}" class="btn btn-sm btn-warning me-1" title="Düzenle"><i class="fas fa-edit"></i></a>` : '';
                            var silBtn = isManuel ? `<a href="/Kasa/HareketSil/${row.kasaHareketID}" class="btn btn-sm btn-danger" title="Sil"><i class="fas fa-trash"></i></a>` : '';
                            
                            return detayBtn + duzenleBtn + silBtn;
                        }
                    }
                ],
                "columns": [
                    { "data": "kasaHareketID", "name": "KasaHareketID", "autoWidth": true },
                    { "data": "tarih", "name": "Tarih", "autoWidth": true },
                    { "data": "hareketTuru", "name": "HareketTuru", "autoWidth": true },
                    { "data": "tutar", "name": "Tutar", "autoWidth": true },
                    { "data": "referansNo", "name": "ReferansNo", "autoWidth": true },
                    { "data": "referansTuru", "name": "ReferansTuru", "autoWidth": true },
                    { "data": "aciklama", "name": "Aciklama", "autoWidth": true },
                    { "data": "cariUnvani", "name": "CariUnvani", "autoWidth": true },
                    { "data": null, "name": "İşlemler", "autoWidth": true }
                ],
                "order": [[1, "desc"]]
            });
            
            // Otomatik kapanan alertler
            window.setTimeout(function() {
                $(".alert").fadeTo(500, 0).slideUp(500, function() {
                    $(this).remove();
                });
            }, 4000);

            // Yeni Kasa Hareketi Modal
            $('#yeniKasaHareketModal').on('shown.bs.modal', function (e) {
                var button = $(e.relatedTarget);
                var kasaId = button.data('id');
                
                // Modal içeriğini temizle
                $('#yeniKasaHareketContainer').html('<div class="modal-body text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Yükleniyor...</span></div></div>');
                
                // Modal içeriğini yükle
                $.ajax({
                    url: '@Url.Action("YeniHareket", "Kasa")',
                    type: 'GET',
                    data: { id: kasaId },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(data) {
                        $('#yeniKasaHareketContainer').html(data);
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: 'Kasa hareketi formu yüklenirken bir hata oluştu: ' + error,
                            confirmButtonText: 'Tamam'
                        });
                        $('#yeniKasaHareketModal').modal('hide');
                    }
                });
            });
            
            // Modal kapandığında event
            $('#yeniKasaHareketModal').on('hidden.bs.modal', function () {
                // Modal içeriğini temizle
                $('#yeniKasaHareketContainer').html('');
            });
            
            // İşlem başarılı olduğunda tabloyu yenile
            $(document).on('kasaHareketiEklendi', function(event, data) {
                // DataTable'ı yenile
                table.ajax.reload();
                
                // Başarı mesajı göster
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: 'Kasa hareketi başarıyla eklendi.',
                    confirmButtonText: 'Tamam'
                });
                
                // Modal'ı kapat
                $('#yeniKasaHareketModal').modal('hide');
            });
        });
    </script>
} 