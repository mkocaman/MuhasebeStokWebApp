@model MuhasebeStokWebApp.ViewModels.SistemLog.SistemLogListViewModel
@{
    ViewData["Title"] = "Sistem Logları";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Sistem Logları</h4>
        </div>
        <div class="card-body">
            <!-- Filtre Formu -->
            <form method="get" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="searchString" class="form-label">Arama</label>
                        <input type="text" class="form-control" id="searchString" name="searchString" value="@ViewBag.SearchString" placeholder="Kayıt adı, açıklama, kullanıcı...">
                    </div>
                    <div class="col-md-3">
                        <label for="islemTuru" class="form-label">İşlem Türü</label>
                        <select class="form-select" id="islemTuru" name="islemTuru">
                            <option value="">Tümü</option>
                            @if (ViewBag.IslemTurleri != null)
                            {
                                @foreach (var islemTuru in ViewBag.IslemTurleri)
                                {
                                    if (ViewBag.IslemTuru == islemTuru)
                                    {
                                        <option value="@islemTuru" selected>@islemTuru</option>
                                    }
                                    else
                                    {
                                        <option value="@islemTuru">@islemTuru</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="baslangicTarihi" class="form-label">Başlangıç Tarihi</label>
                        <input type="date" class="form-control" id="baslangicTarihi" name="baslangicTarihi" value="@(ViewBag.BaslangicTarihi?.ToString("yyyy-MM-dd"))">
                    </div>
                    <div class="col-md-2">
                        <label for="bitisTarihi" class="form-label">Bitiş Tarihi</label>
                        <input type="date" class="form-control" id="bitisTarihi" name="bitisTarihi" value="@(ViewBag.BitisTarihi?.ToString("yyyy-MM-dd"))">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Filtrele</button>
                    </div>
                </div>
            </form>

            <!-- Log Tablosu -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>İşlem Tarihi</th>
                            <th>İşlem Türü</th>
                            <th>Tablo</th>
                            <th>Kayıt Adı</th>
                            <th>Kullanıcı</th>
                            <th>Açıklama</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Logs != null)
                        {
                            @foreach (var log in Model.Logs)
                            {
                                <tr>
                                    <td>@log.IslemTarihi.ToString("dd.MM.yyyy HH:mm:ss")</td>
                                    <td>@log.IslemTuru</td>
                                    <td>@log.TabloAdi</td>
                                    <td>@log.KayitAdi</td>
                                    <td>@(string.IsNullOrEmpty(log.KullaniciAdi) ? "-" : log.KullaniciAdi)</td>
                                    <td>@log.Aciklama</td>
                                    <td>
                                        @if (log.Basarili)
                                        {
                                            <span class="badge bg-success">Başarılı</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Başarısız</span>
                                        }
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="openDetailsModal('@log.Id')">
                                            <i class="fas fa-eye"></i> Detay
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Sayfalama -->
            @if (Model != null && Model.TotalPages > 1)
            {
                <nav aria-label="Sayfalama">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="1" asp-route-searchString="@ViewBag.SearchString" asp-route-islemTuru="@ViewBag.IslemTuru" asp-route-baslangicTarihi="@ViewBag.BaslangicTarihi" asp-route-bitisTarihi="@ViewBag.BitisTarihi">İlk</a>
                        </li>
                        <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage - 1)" asp-route-searchString="@ViewBag.SearchString" asp-route-islemTuru="@ViewBag.IslemTuru" asp-route-baslangicTarihi="@ViewBag.BaslangicTarihi" asp-route-bitisTarihi="@ViewBag.BitisTarihi">Önceki</a>
                        </li>
                        
                        @{
                            int startPage = Math.Max(1, Model.CurrentPage - 2);
                            int endPage = Math.Min(Model.TotalPages, startPage + 4);
                            
                            if (endPage - startPage < 4 && startPage > 1)
                            {
                                startPage = Math.Max(1, endPage - 4);
                            }
                        }
                        
                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-searchString="@ViewBag.SearchString" asp-route-islemTuru="@ViewBag.IslemTuru" asp-route-baslangicTarihi="@ViewBag.BaslangicTarihi" asp-route-bitisTarihi="@ViewBag.BitisTarihi">@i</a>
                            </li>
                        }
                        
                        <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@(Model.CurrentPage + 1)" asp-route-searchString="@ViewBag.SearchString" asp-route-islemTuru="@ViewBag.IslemTuru" asp-route-baslangicTarihi="@ViewBag.BaslangicTarihi" asp-route-bitisTarihi="@ViewBag.BitisTarihi">Sonraki</a>
                        </li>
                        <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@Model.TotalPages" asp-route-searchString="@ViewBag.SearchString" asp-route-islemTuru="@ViewBag.IslemTuru" asp-route-baslangicTarihi="@ViewBag.BaslangicTarihi" asp-route-bitisTarihi="@ViewBag.BitisTarihi">Son</a>
                        </li>
                    </ul>
                </nav>
            }
            
            @if (Model != null) 
            {
                <div class="text-center mt-3">
                    <p>Toplam @Model.TotalItems kayıt, @Model.TotalPages sayfa</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Log Detay Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1" aria-labelledby="logDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailModalLabel">Log Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body" id="logDetailModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Tarih alanları için datepicker
            $('#baslangicTarihi, #bitisTarihi').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                language: 'tr'
            });
        });
        
        function openDetailsModal(id) {
            $('#logDetailModalBody').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Yükleniyor...</span></div></div>');
            $('#logDetailModal').modal('show');
            
            $.ajax({
                url: '/SistemLog/Details/' + id,
                type: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function (data) {
                    $('#logDetailModalBody').html(data);
                },
                error: function () {
                    $('#logDetailModalBody').html('<div class="alert alert-danger">Log detayları yüklenirken bir hata oluştu.</div>');
                }
            });
        }
    </script>
} 