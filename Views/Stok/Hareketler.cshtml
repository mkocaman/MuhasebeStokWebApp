@model MuhasebeStokWebApp.ViewModels.Stok.StokHareketViewModel
@using MuhasebeStokWebApp.Enums
@{
    ViewData["Title"] = "Stok Hareketleri";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Stok Hareketleri - @Model.UrunAdi</h4>
                <a asp-action="Index" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Listeye Dön
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Ürün Bilgileri</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <tr>
                                    <th style="width: 40%">Ürün Kodu:</th>
                                    <td>@Model.UrunKodu</td>
                                </tr>
                                <tr>
                                    <th>Ürün Adı:</th>
                                    <td>@Model.UrunAdi</td>
                                </tr>
                                <tr>
                                    <th>Kategori:</th>
                                    <td>@Model.Kategori</td>
                                </tr>
                                <tr>
                                    <th>Birim:</th>
                                    <td>@Model.Birim</td>
                                </tr>
                                <tr>
                                    <th>Stok Miktarı:</th>
                                    <td>@Model.StokMiktar.ToString("N2") @Model.Birim</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Maliyet Bilgileri</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <tr>
                                    <th style="width: 40%">Ortalama Maliyet (UZS):</th>
                                    <td class="text-end">@Model.OrtalamaMaliyetUZS.ToString("N2") so'm</td>
                                </tr>
                                <tr>
                                    <th>Ortalama Maliyet (USD):</th>
                                    <td class="text-end">@Model.OrtalamaMaliyetUSD.ToString("N2") $</td>
                                </tr>
                                <tr>
                                    <th>Toplam Stok Değeri (UZS):</th>
                                    <td class="text-end">@((Model.OrtalamaMaliyetUZS * Model.StokMiktar).ToString("N2")) so'm</td>
                                </tr>
                                <tr>
                                    <th>Toplam Stok Değeri (USD):</th>
                                    <td class="text-end">@((Model.OrtalamaMaliyetUSD * Model.StokMiktar).ToString("N2")) $</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yeni Satış Bilgileri Bölümü -->
            <div class="row mb-4">
                <div class="col-md-6 offset-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Satış Bilgileri</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <tr>
                                    <th style="width: 40%">Ortalama Satış Fiyatı (UZS):</th>
                                    <td class="text-end">@(Model.OrtalamaSatisFiyatiUZS > 0 ? Model.OrtalamaSatisFiyatiUZS.ToString("N2") + " so'm" : "-")</td>
                                </tr>
                                <tr>
                                    <th>Ortalama Satış Fiyatı (USD):</th>
                                    <td class="text-end">@(Model.OrtalamaSatisFiyatiUSD > 0 ? Model.OrtalamaSatisFiyatiUSD.ToString("N2") + " $" : "-")</td>
                                </tr>
                                <tr>
                                    <th>Ortalama Kâr Marjı:</th>
                                    <td class="text-end">
                                        @if (Model.OrtalamaSatisFiyatiUZS > 0 && Model.OrtalamaMaliyetUZS > 0)
                                        {
                                            decimal karMarji = ((Model.OrtalamaSatisFiyatiUZS - Model.OrtalamaMaliyetUZS) / Model.OrtalamaMaliyetUZS) * 100;
                                            @karMarji.ToString("N2")@:%
                                        }
                                        else
                                        {
                                            @:-
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <th>Toplam Tahmini Satış Değeri (UZS):</th>
                                    <td class="text-end">@(Model.ToplamTahminiSatisDegeriUZS > 0 ? Model.ToplamTahminiSatisDegeriUZS.ToString("N2") + " so'm" : "-")</td>
                                </tr>
                                <tr>
                                    <th>Toplam Tahmini Satış Değeri (USD):</th>
                                    <td class="text-end">@(Model.ToplamTahminiSatisDegeriUSD > 0 ? Model.ToplamTahminiSatisDegeriUSD.ToString("N2") + " $" : "-")</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="hareketler-tab" data-bs-toggle="tab" data-bs-target="#hareketler" type="button" role="tab" aria-controls="hareketler" aria-selected="true">Stok Hareketleri</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fifo-tab" data-bs-toggle="tab" data-bs-target="#fifo" type="button" role="tab" aria-controls="fifo" aria-selected="false">FIFO Kayıtları</button>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="hareketler" role="tabpanel" aria-labelledby="hareketler-tab">
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-hover" id="hareketlerTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Tarih</th>
                                    <th>Hareket Türü</th>
                                    <th>Depo</th>
                                    <th>Miktar</th>
                                    <th>Birim Fiyat</th>
                                    <th>Tutar</th>
                                    <th>Referans</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var hareket in Model.StokHareketleri)
                                {
                                    <tr>
                                        <td>@hareket.Tarih.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>
                                            @if (hareket.HareketTuru == StokHareketTipi.Giris)
                                            {
                                                <span class="badge bg-success">Giriş</span>
                                            }
                                            else if (hareket.HareketTuru == StokHareketTipi.Cikis)
                                            {
                                                <span class="badge bg-danger">Çıkış</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@hareket.HareketTuru</span>
                                            }
                                        </td>
                                        <td>@hareket.DepoAdi</td>
                                        <td class="text-end">@hareket.Miktar.ToString("N2") @hareket.Birim</td>
                                        <td class="text-end">@hareket.BirimFiyat.ToString("N2") @hareket.ParaBirimiSembol</td>
                                        <td class="text-end">@((hareket.Miktar * hareket.BirimFiyat).ToString("N2")) @hareket.ParaBirimiSembol</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(hareket.ReferansTuru))
                                            {
                                                <span>@hareket.ReferansTuru</span>
                                            }
                                            @if (!string.IsNullOrEmpty(hareket.ReferansNo))
                                            {
                                                <span> - @hareket.ReferansNo</span>
                                            }
                                        </td>
                                        <td>@hareket.Aciklama</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="fifo" role="tabpanel" aria-labelledby="fifo-tab">
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-hover" id="fifoTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Giriş Tarihi</th>
                                    <th>Son Çıkış</th>
                                    <th>Miktar</th>
                                    <th>Kalan</th>
                                    <th>Birim Fiyat (Orijinal)</th>
                                    <th>Birim Fiyat (UZS)</th>
                                    <th>Birim Fiyat (USD)</th>
                                    <th>Döviz Kuru</th>
                                    <th>Referans</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var fifo in Model.FifoKayitlari)
                                {
                                    <tr>
                                        <td>@fifo.GirisTarihi.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>
                                            @if (fifo.SonCikisTarihi.HasValue)
                                            {
                                                @fifo.SonCikisTarihi.Value.ToString("dd.MM.yyyy HH:mm")
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                        <td class="text-end">@fifo.Miktar.ToString("N2")</td>
                                        <td class="text-end">@fifo.KalanMiktar.ToString("N2")</td>
                                        <td class="text-end">@fifo.BirimFiyat.ToString("N2") @fifo.ParaBirimiSembol</td>
                                        <td class="text-end">@fifo.BirimFiyatUZS.ToString("N2") so'm</td>
                                        <td class="text-end">@fifo.BirimFiyatUSD.ToString("N2") $</td>
                                        <td class="text-end">@fifo.DovizKuru.ToString("N6")</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(fifo.ReferansTuru))
                                            {
                                                <span>@fifo.ReferansTuru</span>
                                            }
                                            @if (!string.IsNullOrEmpty(fifo.ReferansNo))
                                            {
                                                <span> - @fifo.ReferansNo</span>
                                            }
                                        </td>
                                        <td>
                                            @if (fifo.KalanMiktar > 0)
                                            {
                                                <span class="badge bg-success">Aktif</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Tüketildi</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTable başlatma
            try {
                $('#hareketlerTable').DataTable({
                    language: {
                        "emptyTable": "Tabloda herhangi bir veri mevcut değil",
                        "info": "_TOTAL_ kayıttan _START_ - _END_ arasındaki kayıtlar gösteriliyor",
                        "infoEmpty": "Kayıt yok",
                        "infoFiltered": "(_MAX_ kayıt içerisinden bulunan)",
                        "infoPostFix": "",
                        "thousands": ".",
                        "lengthMenu": "Sayfada _MENU_ kayıt göster",
                        "loadingRecords": "Yükleniyor...",
                        "processing": "İşleniyor...",
                        "search": "Ara:",
                        "zeroRecords": "Eşleşen kayıt bulunamadı",
                        "paginate": {
                            "first": "İlk",
                            "last": "Son",
                            "next": "Sonraki",
                            "previous": "Önceki"
                        }
                    },
                    responsive: true,
                    retrieve: true,
                    pageLength: 25,
                    order: [[0, "desc"]] // Tarih sütununa göre azalan sıralama
                });
                
                $('#fifoTable').DataTable({
                    language: {
                        "emptyTable": "Tabloda herhangi bir veri mevcut değil",
                        "info": "_TOTAL_ kayıttan _START_ - _END_ arasındaki kayıtlar gösteriliyor",
                        "infoEmpty": "Kayıt yok",
                        "infoFiltered": "(_MAX_ kayıt içerisinden bulunan)",
                        "infoPostFix": "",
                        "thousands": ".",
                        "lengthMenu": "Sayfada _MENU_ kayıt göster",
                        "loadingRecords": "Yükleniyor...",
                        "processing": "İşleniyor...",
                        "search": "Ara:",
                        "zeroRecords": "Eşleşen kayıt bulunamadı",
                        "paginate": {
                            "first": "İlk",
                            "last": "Son",
                            "next": "Sonraki",
                            "previous": "Önceki"
                        }
                    },
                    responsive: true,
                    retrieve: true,
                    pageLength: 25,
                    order: [[0, "asc"]] // Giriş tarihine göre artan sıralama
                });
            } catch (e) {
                console.log("DataTable başlatılırken bir hata oluştu, ancak işlem devam ediyor.");
            }
        });
    </script>
} 