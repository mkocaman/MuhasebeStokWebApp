@model MuhasebeStokWebApp.ViewModels.Stok.StokListViewModel
@{
    ViewData["Title"] = "Stok İzleme ve Kontrol Merkezi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-boxes"></i> Stok Yönetimi</h4>
                <div>
                    <a asp-controller="StokGiris" asp-action="Create" class="btn btn-success">
                        <i class="fas fa-arrow-down"></i> Stok Girişi
                    </a>
                    <a asp-controller="StokCikis" asp-action="Create" class="btn btn-light">
                        <i class="fas fa-arrow-up"></i> Stok Çıkışı
                    </a>
                    <a asp-controller="StokTransfer" asp-action="Create" class="btn btn-light">
                        <i class="fas fa-exchange-alt"></i> Stok Transferi
                    </a>
                    <button type="button" class="btn btn-warning" id="excelExportBtn">
                        <i class="fas fa-file-export"></i> Excel'e Aktar
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <form asp-action="Index" method="get" class="mb-4">
                <div class="row">
                    <div class="col-md-5">
                        <div class="input-group">
                            <input type="text" name="searchString" class="form-control" placeholder="Ürün adı veya kodu ara..." value="@ViewBag.CurrentFilter">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-search"></i> Ara
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <select name="depoID" class="form-select" id="depoFilter">
                                <option value="">-- Tüm Depolar --</option>
                                @foreach (var depo in ViewBag.Depolar ?? new List<MuhasebeStokWebApp.Data.Entities.Depo>())
                                {
                                    if (ViewBag.CurrentDepo != null && ViewBag.CurrentDepo.ToString() == depo.DepoID.ToString())
                                    {
                                        <option value="@depo.DepoID" selected>@depo.DepoAdi</option>
                                    }
                                    else
                                    {
                                        <option value="@depo.DepoID">@depo.DepoAdi</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <select name="kategoriID" class="form-select" id="kategoriFilter">
                                <option value="">-- Tüm Kategoriler --</option>
                                @foreach (var kategori in ViewBag.Kategoriler ?? new List<MuhasebeStokWebApp.Data.Entities.UrunKategori>())
                                {
                                    if (ViewBag.CurrentKategori != null && ViewBag.CurrentKategori.ToString() == kategori.KategoriID.ToString())
                                    {
                                        <option value="@kategori.KategoriID" selected>@kategori.KategoriAdi</option>
                                    }
                                    else
                                    {
                                        <option value="@kategori.KategoriID">@kategori.KategoriAdi</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Stok Sekmeleri -->
            <ul class="nav nav-tabs mb-3" id="stokTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="tum-stoklar-tab" data-bs-toggle="tab" data-bs-target="#tum-stoklar" type="button" role="tab" aria-controls="tum-stoklar" aria-selected="true">
                        <i class="fas fa-boxes text-success"></i> Tüm Stoklar
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="kritik-stoklar-tab" data-bs-toggle="tab" data-bs-target="#kritik-stoklar" type="button" role="tab" aria-controls="kritik-stoklar" aria-selected="false">
                        <i class="fas fa-exclamation-triangle text-danger"></i> Kritik Stoklar
                    </a>
                </li>
            </ul>
            
            <!-- Sekme İçerikleri -->
            <div class="tab-content" id="stokTabsContent">
                <!-- Tüm Stoklar Sekmesi -->
                <div class="tab-pane fade show active" id="tum-stoklar" role="tabpanel" aria-labelledby="tum-stoklar-tab">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="tumStoklarTablosu">
                            <thead class="table-light">
                                <tr>
                                    <th>Ürün Kodu</th>
                                    <th>Ürün Adı</th>
                                    <th>Kategori</th>
                                    <th>Depo</th>
                                    <th>Birim</th>
                                    <th>Stok Miktarı</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Urunler)
                                {
                                    <tr>
                                        <td>@item.UrunKodu</td>
                                        <td>@item.UrunAdi</td>
                                        <td>@item.Kategori</td>
                                        <td>@item.DepoAdi</td>
                                        <td>@item.Birim</td>
                                        <td class="text-end">@item.StokMiktar.ToString("N2") @item.Birim</td>
                                        <td class="text-center">
                                            @if (item.StokMiktar <= item.KritikStokSeviyesi)
                                            {
                                                <span class="badge bg-danger">Kritik</span>
                                            }
                                            else if (item.StokMiktar <= item.KritikStokSeviyesi * 1.5m)
                                            {
                                                <span class="badge bg-warning">Düşük</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">Normal</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <a asp-action="Hareketler" asp-route-id="@item.UrunID" class="btn btn-sm btn-info" title="Stok Hareketleri">
                                                    <i class="fas fa-history"></i>
                                                </a>
                                                <a asp-controller="StokGiris" asp-action="Create" asp-route-urunId="@item.UrunID" class="btn btn-sm btn-success" title="Stok Girişi">
                                                    <i class="fas fa-arrow-down"></i>
                                                </a>
                                                <a asp-controller="StokCikis" asp-action="Create" asp-route-urunId="@item.UrunID" class="btn btn-sm btn-danger" title="Stok Çıkışı">
                                                    <i class="fas fa-arrow-up"></i>
                                                </a>
                                                <a asp-controller="Urun" asp-action="Details" asp-route-id="@item.UrunID" class="btn btn-sm btn-primary" title="Ürün Detayları">
                                                    <i class="fas fa-box-open"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Kritik Stoklar Sekmesi -->
                <div class="tab-pane fade" id="kritik-stoklar" role="tabpanel" aria-labelledby="kritik-stoklar-tab">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="kritikStoklarTablosu">
                            <thead class="table-light">
                                <tr>
                                    <th>Ürün Kodu</th>
                                    <th>Ürün Adı</th>
                                    <th>Kategori</th>
                                    <th>Depo</th>
                                    <th>Birim</th>
                                    <th>Stok Miktarı</th>
                                    <th>Kritik Seviye</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Urunler.Where(s => s.StokMiktar <= s.KritikStokSeviyesi))
                                {
                                    <tr>
                                        <td>@item.UrunKodu</td>
                                        <td>@item.UrunAdi</td>
                                        <td>@item.Kategori</td>
                                        <td>@item.DepoAdi</td>
                                        <td>@item.Birim</td>
                                        <td class="text-end text-danger fw-bold">@item.StokMiktar.ToString("N2") @item.Birim</td>
                                        <td class="text-end">@item.KritikStokSeviyesi.ToString("N2") @item.Birim</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <a asp-controller="StokGiris" asp-action="Create" asp-route-urunId="@item.UrunID" class="btn btn-sm btn-success" title="Stok Girişi">
                                                    <i class="fas fa-arrow-down"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-warning open-alarm-modal" data-id="@item.UrunID" data-urun="@item.UrunAdi" data-miktar="@item.StokMiktar.ToString("N2")" data-birim="@item.Birim">
                                                    <i class="fas fa-bell"></i>
                                                </button>
                                                <a asp-action="Hareketler" asp-route-id="@item.UrunID" class="btn btn-sm btn-info" title="Stok Hareketleri">
                                                    <i class="fas fa-history"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stok Bildirim Modal -->
<div class="modal fade" id="stokBildirimModal" tabindex="-1" aria-labelledby="stokBildirimModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="stokBildirimModalLabel">Stok Bildirim Oluştur</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> <span id="urunBilgisi"></span> ürünü kritik stok seviyesinin altında!
                </div>
                <form id="stokBildirimForm">
                    <div class="mb-3">
                        <label for="bildirimNotu" class="form-label">Bildirim Notu</label>
                        <textarea class="form-control" id="bildirimNotu" rows="3" placeholder="Bu ürünün acilen tedarik edilmesi gerekiyor..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bildirim Alıcıları</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="satinalma" id="satinalmaCheckbox" checked>
                            <label class="form-check-label" for="satinalmaCheckbox">
                                Satın Alma Departmanı
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="yonetim" id="yonetimCheckbox">
                            <label class="form-check-label" for="yonetimCheckbox">
                                Yönetim
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="depo" id="depoCheckbox">
                            <label class="form-check-label" for="depoCheckbox">
                                Depo Sorumlusu
                            </label>
                        </div>
                    </div>
                    <input type="hidden" id="bildirimdekiUrunID" value="" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-warning" id="submitStokBildirim">
                    <i class="fas fa-paper-plane"></i> Bildirimi Gönder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stok Hareket Detay Modal -->
<div class="modal fade" id="stokHareketDetayModal" tabindex="-1" aria-labelledby="stokHareketDetayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="stokHareketDetayModalLabel">Stok Hareketi Detayları</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="stokHareketDetayModalContent">
                <!-- İçerik AJAX ile yüklenecek -->
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // DataTable uyarılarını gizle
            $.fn.dataTable.ext.errMode = 'none';
            
            // Tüm stoklar tablosunu başlat
            var tumStoklarTable = $('#tumStoklarTablosu').DataTable({
                language: {
                    url: '/js/dataTables.turkish.json'
                },
                responsive: true,
                order: [[5, 'asc']], // Stok miktarına göre sırala
                columnDefs: [
                    { responsivePriority: 1, targets: 1 }, // Ürün adı
                    { responsivePriority: 2, targets: 5 }, // Stok miktarı
                    { responsivePriority: 3, targets: 6 }, // Durum
                    { orderable: false, targets: -1 } // Son sütun (İşlemler)
                ]
            });
            
            // Kritik stoklar tablosunu başlat
            var kritikStoklarTable = $('#kritikStoklarTablosu').DataTable({
                language: {
                    url: '/js/dataTables.turkish.json'
                },
                responsive: true,
                order: [[5, 'asc']], // Stok miktarına göre sırala (en az olanlar önce)
                columnDefs: [
                    { responsivePriority: 1, targets: 1 }, // Ürün adı
                    { responsivePriority: 2, targets: 5 }, // Stok miktarı
                    { orderable: false, targets: -1 } // Son sütun (İşlemler)
                ]
            });
            
            // Filtreler değiştiğinde otomatik olarak formu submit et
            $('#depoFilter, #kategoriFilter').on('change', function() {
                $(this).closest('form').submit();
            });
            
            // Stok Tab değişikliği
            $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                // DataTable responsive düzenleme
                $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
            });
            
            // Bildirim modal'ını aç
            $(document).on('click', '.open-alarm-modal', function() {
                var urunID = $(this).data('id');
                var urunAdi = $(this).data('urun');
                var stokMiktar = $(this).data('miktar');
                var birim = $(this).data('birim');
                
                $('#bildirimdekiUrunID').val(urunID);
                $('#urunBilgisi').text(urunAdi + ' (' + stokMiktar + ' ' + birim + ')');
                $('#stokBildirimModal').modal('show');
            });
            
            // Bildirim gönder
            $('#submitStokBildirim').on('click', function() {
                var urunID = $('#bildirimdekiUrunID').val();
                var bildirimNotu = $('#bildirimNotu').val();
                var bildirimAlicilar = [];
                
                // Seçili alıcıları al
                $('input[type=checkbox]:checked').each(function() {
                    bildirimAlicilar.push($(this).val());
                });
                
                if (bildirimAlicilar.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Uyarı!',
                        text: 'Lütfen en az bir alıcı seçin.',
                        confirmButtonText: 'Tamam'
                    });
                    return;
                }
                
                // AJAX ile bildirimi gönder
                $.ajax({
                    url: '@Url.Action("SendStokBildirim", "Stok")',
                    type: 'POST',
                    data: {
                        urunID: urunID,
                        bildirimNotu: bildirimNotu,
                        bildirimAlicilar: bildirimAlicilar
                    },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Başarılı!',
                                text: response.message || 'Stok bildirimi başarıyla gönderildi.',
                                confirmButtonText: 'Tamam'
                            }).then(() => {
                                $('#stokBildirimModal').modal('hide');
                                // Form alanlarını temizle
                                $('#bildirimNotu').val('');
                                $('#bildirimdekiUrunID').val('');
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: response.message || 'Stok bildirimi gönderilirken bir hata oluştu.',
                                confirmButtonText: 'Tamam'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: 'İşlem sırasında bir hata oluştu.',
                            confirmButtonText: 'Tamam'
                        });
                    }
                });
            });
            
            // Excel'e aktar butonu
            $('#excelExportBtn').on('click', function() {
                // Parametreleri al
                var searchString = $('input[name="searchString"]').val() || '';
                var depoID = $('#depoFilter').val() || '';
                var kategoriID = $('#kategoriFilter').val() || '';
                
                // Excel indirme URL'i oluştur
                var url = '@Url.Action("ExportToExcel", "Stok")';
                url += '?searchString=' + encodeURIComponent(searchString);
                url += '&depoID=' + encodeURIComponent(depoID);
                url += '&kategoriID=' + encodeURIComponent(kategoriID);
                
                // Yeni pencerede aç
                window.location.href = url;
            });
        });
    </script>
} 